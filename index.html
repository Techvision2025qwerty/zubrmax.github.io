<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="keywords" content="ZubrAI , ZubrMax , Zubr">
  <title>–ó–£–ë–† Max</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://unpkg.com/easyqrcodejs@4.4.11/dist/easy.qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <style>
    /* General Glassmorphism Style */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, rgba(173, 216, 230, 0.8), rgba(255, 255, 255, 0.9));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #1c1c1e;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: background-image 0.5s ease;
    }
    /* Top bar */
    .top-bar {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 100;
      left: 20px;
      justify-content: space-between;
      transition: opacity 0.3s ease;
    }
    .top-buttons {
        display: flex;
        gap: 15px;
    }
    /* –û—Å—Ç–∞–≤—à–∞—è—Å—è –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é –≤–≤–µ—Ä—Ö—É */
    .menu-button {
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2em;
      color: #1c1c1e;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .menu-button:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    /* Wallpaper button */
    #wallpaper-button {
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      color: #1c1c1e;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    #wallpaper-button:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    /* Weather Widget and Universal Menu Container */
    .right-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px; /* 1 cm = 10px */
    }
    .weather-widget {
        width: 58px;
        height: 58px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 9px;
        border-radius: 14px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: background 0.5s ease, backdrop-filter 0.5s ease;
        cursor: pointer;
        color: #1c1c1e;
        position: relative;
        overflow: hidden;
    }
    .weather-widget::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: inherit;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: -1;
    }
    .weather-emoji {
        font-size: 1.8em;
        line-height: 1;
        margin-bottom: 5px;
    }
    .weather-temp {
        font-size: 1.1em;
        font-weight: bold;
    }
    .weather-widget.clear { background: rgba(255, 223, 186, 0.7); }
    .weather-widget.clouds { background: rgba(200, 200, 200, 0.7); }
    .weather-widget.rain { background: rgba(173, 216, 230, 0.7); }
    .weather-widget.thunderstorm { background: rgba(100, 100, 100, 0.7); color: #fff; }
    .weather-widget.snow { background: rgba(240, 248, 255, 0.7); }
    .weather-widget.default { background: rgba(255, 255, 255, 0.3); }
    /* Universal Menu Button under Weather */
    .universal-menu-button {
      width: 70px;
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2em;
      color: #1c1c1e;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .universal-menu-button:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    /* Microphone Overlay */
    .microphone-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(15px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.5s ease, background 1s ease;
      flex-direction: column;
      text-align: center;
      background-size: cover;
      background-position: center;
    }
    @keyframes pulse-background {
      0% {
        background-color: rgba(0, 119, 201, 0.8);
      }
      50% {
        background-color: rgba(0, 150, 255, 0.8);
      }
      100% {
        background-color: rgba(0, 119, 201, 0.8);
      }
    }
    .microphone-overlay.active {
      display: flex;
      opacity: 1;
      background-color: rgba(0, 119, 201, 0.8);
      animation: pulse-background 3s infinite ease-in-out;
    }
    .microphone-overlay.custom-background {
      animation: none;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .microphone-overlay.white-background {
      animation: none;
      background-color: rgba(255, 255, 255, 0.8);
    }
    .microphone-overlay.white-background .microphone-icon,
    .microphone-overlay.white-background .wave,
    .microphone-overlay.white-background .mic-instructions,
    .microphone-overlay.white-background .subtitle-box,
    .microphone-overlay.white-background .mic-close-button {
        color: #1c1c1e;
    }
    .microphone-overlay.white-background .subtitle-box {
        background: rgba(0, 0, 0, 0.2);
    }
    .microphone-icon {
      font-size: 5em;
      color: #fff;
      margin-bottom: 20px;
    }
    .wave-container {
      position: relative;
      width: 200px;
      height: 100px;
    }
    .wave {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 5px;
      height: 5px;
      background: #0000ff;
      border-radius: 50%;
      opacity: 0;
      animation: waveAnimation 1.5s ease-in-out infinite;
    }
    .wave:nth-child(2) { animation-delay: 0.3s; background: #00008b; }
    .wave:nth-child(3) { animation-delay: 0.6s; background: #0000ff; }
    @keyframes waveAnimation {
      0% { transform: translate(-50%, 0) scale(1); opacity: 0.5; }
      50% { transform: translate(-50%, -50px) scale(3); opacity: 1; }
      100% { transform: translate(-50%, -100px) scale(5); opacity: 0; }
    }
    .mic-instructions {
        color: #fff;
        font-size: 1.2em;
        margin-top: 20px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    /* New subtitle box */
    .subtitle-box {
      position: absolute;
      bottom: 50px;
      width: 80%;
      max-width: 600px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      color: #fff;
      font-size: 1.1em;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      min-height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.5s ease;
      line-height: 1.5;
      text-align: center;
    }
    .subtitle-box.active {
        opacity: 1;
    }
    .mic-close-button {
        position: absolute;
        top: 30px;
        right: 30px;
        color: #fff;
        font-size: 2em;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    .mic-controls {
      position: absolute;
      top: 30px;
      left: 30px;
      display: flex;
      gap: 15px;
    }
    .mic-controls .color-picker-button {
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2em;
      color: #7B68EE;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .mic-controls .color-picker-button {
        color: #fff;
        background: rgba(255, 255, 255, 0.2);
    }
    .color-picker-menu {
        position: absolute;
        top: 80px;
        left: 30px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        gap: 10px;
        z-index: 201;
    }
    .color-picker-menu.active {
        display: flex;
    }
    .color-picker-menu button {
        padding: 10px 15px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: background 0.3s ease;
        font-size: 1em;
        color: #1c1c1e;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .color-picker-menu button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    /* NEW: Language selector in mic overlay */
    .mic-language-select {
      position: absolute;
      top: 80px;
      left: 30px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 201;
    }
    .mic-language-select.active {
        display: flex;
    }
    .mic-language-select select {
        padding: 10px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7);
        color: #1c1c1e;
        font-size: 1em;
    }
    /* Chat Menu */
    .chat-menu {
      position: fixed;
      top: 0;
      left: -300px;
      height: 100vh;
      width: 280px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(25px);
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
      transition: left 0.4s ease-in-out;
      z-index: 99;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .chat-menu.active {
      left: 0;
    }
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .menu-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    #low-vision-button {
        width: 100%;
        padding: 10px 15px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #28a745, #218838);
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease, transform 0.2s ease;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    #low-vision-button:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: translateY(-1px);
    }
    #project-menu-button {
        width: 100%;
        padding: 10px 15px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease, transform 0.2s ease;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    #project-menu-button:hover {
        background: linear-gradient(135deg, #FF8E53, #FF6B6B);
        transform: translateY(-1px);
    }
    /* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø QR-–ö–û–î–ê */
    #qrcode-menu-button {
        width: 100%;
        padding: 10px 15px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #1E90FF, #4682B4);
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease, transform 0.2s ease;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    #qrcode-menu-button:hover {
        background: linear-gradient(135deg, #4682B4, #1E90FF);
        transform: translateY(-1px);
    }
    /* üí• –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –í–´–ë–û–†–ê –Ø–ó–´–ö–ê üí• */
    #language-menu-item {
        width: 100%;
        padding: 10px 3px;
        border: none;
        border-radius: 4px;
        background: rgba(108, 117, 125, 0.7);
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease;
        justify-content: space-between;
        position: relative;
    }
    #language-menu-item:hover {
        background: rgba(108, 117, 125, 1);
    }
    .language-submenu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        gap: 8px;
        min-width: 100%;
        z-index: 101;
    }
    .language-submenu.active {
        display: flex;
    }
    .language-submenu button {
        padding: 8px 12px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7);
        color: #1c1c1e;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.3s ease;
        text-align: left;
    }
    .language-submenu button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    /* ----------------------------------------------------- */
    .new-chat-button, .albums-menu-button, .speak-button {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: rgba(30, 144, 255, 0.7);
      color: #fff;
      cursor: pointer;
      display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease;
    }
    .albums-menu-button {
        background: rgba(147, 112, 219, 0.8);
    }
    .new-chat-button:hover {
      background: rgba(16, 78, 139, 0.8);
    }
    .albums-menu-button:hover {
        background: rgba(147, 112, 219, 1);
    }
    /* New styles for the speak button */
    .speak-button {
      background: #6c757d;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .speak-button.active {
      background: #28a745;
    }
    .speak-button:hover {
      background: #5a6268;
    }
    .speak-button.active:hover {
      background: #218838;
    }
    .chat-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      overflow-y: auto;
      flex-grow: 1;
    }
    .chat-list li {
      padding: 12px 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-list li:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    /* Chat container and messages */
    .chat-container {
      width: 90%;
      max-width: 800px;
      height: 80vh;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      padding: 20px;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      position: relative;
      z-index: 50;
      transition: opacity 0.3s ease;
    }
    /* üí• –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê "–ó–ê–ú–ï–¢–ö–ê" –í –ß–ê–¢–ï üí• - –°–ú–ï–©–ï–ù–ê –í–ù–ò–ó –ù–ê 2.5 –°–ú (94.5px) */
    #quick-note-button {
        position: absolute;
        top: 114.5px;
        right: 20px;
        width: 45px;
        height: 45px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 193, 7, 0.8);
        color: #1c1c1e;
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.3em;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        z-index: 55;
    }
    #quick-note-button:hover {
        background: rgba(255, 193, 7, 1);
        transform: scale(1.05);
    }
    /* ---------------------------------- */
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 16px;
      background: rgba(240, 248, 255, 0.4);
      backdrop-filter: blur(15px);
    }
    .chat-message {
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 70%;
      line-height: 1.4;
      font-size: 0.95em;
      word-wrap: break-word;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.3s ease;
    }
    .chat-message img {
      max-width: 100%;
      border-radius: 12px;
      display: block;
      margin-top: 10px;
      cursor: pointer;
    }
    .user-message {
      margin-left: auto;
      background: linear-gradient(135deg, #1E90FF, #4682B4);
      color: #fff;
    }
    .assistant-message {
      margin-right: auto;
      background: rgba(255, 255, 255, 0.8);
      color: #1c1c1e;
    }
    /* PM Header Style */
    .pm-header {
      font-size: 2em;
      font-weight: bold;
      color: #1E90FF;
      margin: 10px 0;
      display: block;
    }
    /* Input field and buttons */
    .input-container {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    .input-container input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      font-size: 1em;
      border-radius: 20px;
      border: none;
      outline: none;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    .input-container input[type="text"]:focus {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 2px rgba(30, 144, 255, 0.4);
    }
    .input-button {
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      font-size: 1.2em;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .input-container .input-button {
      background: linear-gradient(135deg, #1E90FF, #4682B4);
    }
    .input-container .input-button:hover {
      background: linear-gradient(135deg, #104E8B, #1E90FF);
    }
    /* New styles for menu button and dropdown */
    .menu-dropdown {
        position: relative;
    }
    .input-menu-button {
        width: 45px;
        height: 45px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        color: #1c1c1e;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    /* üí• –ê–ù–ò–ú–ê–¶–ò–Ø –°–í–ï–†–ö–ê–ù–ò–Ø –î–õ–Ø –ö–ù–û–ü–ö–ò + üí• */
    @keyframes buttonShimmer {
        0% { box-shadow: 0 0 5px #1E90FF, 0 0 10px #1E90FF, 0 0 15px #1E90FF, 0 0 20px #7B68EE; }
        50% { box-shadow: 0 0 10px #1E90FF, 0 0 20px #1E90FF, 0 0 30px #1E90FF, 0 0 40px #7B68EE; }
        100% { box-shadow: 0 0 5px #1E90FF, 0 0 10px #1E90FF, 0 0 15px #1E90FF, 0 0 20px #7B68EE; }
    }
    .input-menu-button {
        animation: buttonShimmer 2s infinite;
    }
    /* üí• –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ú–ò–ö–†–û–§–û–ù–ê –í INPUT-–ö–û–ù–¢–ï–ô–ù–ï–†–ï üí• */
    .mic-button {
        width: 45px;
        height: 45px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        color: #1E90FF;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    .mic-button.active {
        background: #1E90FF;
        color: #fff;
    }
    .mic-button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    .input-menu-button.active {
        background: #1E90FF;
        color: #fff;
    }
    .input-menu-button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    .dropdown-menu {
        position: absolute;
        bottom: 60px;
        left: 0;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        gap: 10px;
        z-index: 10;
        min-width: 200px;
    }
    .dropdown-menu.active {
        display: flex;
    }
    .dropdown-menu .menu-item {
        padding: 12px 15px;
        border: none;
        border-radius: 12px;
        background: rgba(30, 144, 255, 0.7);
        color: #fff;
        cursor: pointer;
        font-size: 1em;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        transition: background 0.3s ease;
    }
    .dropdown-menu .menu-item:hover {
        background: rgba(16, 78, 139, 0.8);
    }
    /* Sub-menu for modes */
    .modes-submenu {
        position: absolute;
        bottom: 0;
        left: 100%;
        margin-left: 10px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        gap: 8px;
        min-width: 200px;
    }
    .modes-submenu.active {
        display: flex;
    }
    .modes-submenu button {
        padding: 10px 15px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.7);
        color: #1c1c1e;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
    }
    .modes-submenu button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    .modes-submenu button.active-mode {
        background: #4682B4;
        color: #fff;
    }
    /* Notes Container */
    .notes-container {
        width: 90%;
        max-width: 800px;
        height: 80vh;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .notes-container.active {
        display: flex;
    }
    .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .notes-header h2 {
        margin: 0;
        color: #1c1c1e;
        font-size: 1.8em;
    }
    .notes-header-buttons {
        display: flex;
        gap: 10px;
    }
    .add-note-button, .back-to-chat-button {
        padding: 10px 15px;
        border: none;
        border-radius: 12px;
        background: rgba(30, 144, 255, 0.7);
        color: #fff;
        cursor: pointer;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .back-to-chat-button {
        background: rgba(255, 99, 71, 0.8);
    }
    .add-note-button {
        background: rgba(255, 193, 7, 0.8);
        color: #333;
    }
    .add-note-button:hover {
        background: rgba(255, 193, 7, 1);
    }
    .back-to-chat-button:hover {
        background: rgba(255, 99, 71, 1);
    }
    .notes-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex-grow: 1;
        background: rgba(240, 248, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 15px;
    }
    /* üí• –°–¢–ò–õ–ò –î–õ–Ø –û–¢–î–ï–õ–¨–ù–û–ô –ó–ê–ú–ï–¢–ö–ò üí• */
    .note-item {
        background: #fff8e1;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .note-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .note-item-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 10px;
    }
    .note-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding-top: 5px;
        font-size: 0.85em;
        color: #666;
    }
    .note-item.starred {
        border: 2px solid #ffc107;
    }
    .note-content {
        flex-grow: 1;
        font-size: 1.05em;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 100px;
        overflow: hidden;
    }
    .note-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .note-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        color: #999;
        transition: color 0.3s ease, transform 0.2s ease;
    }
    .note-actions button:hover {
        color: #1c1c1e;
        transform: scale(1.1);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö—Ä–µ—Å—Ç–∏–∫" (–£–¥–∞–ª–µ–Ω–∏–µ) */
    .delete-note-button-inline {
        color: #dc3545;
        margin-left: 10px;
        font-size: 1.4em !important;
    }
    .delete-note-button-inline:hover {
        color: #c82333;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–≤–µ–∑–¥–∞" (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) */
    .star-button-inline {
        color: #ffc107;
    }
    .star-button-inline .far.fa-star {
        color: #999;
    }
    .star-button-inline:hover {
        transform: scale(1.2);
    }
    /* ---------------------------------- */
    /* Note Editor */
    .note-editor {
        display: none;
        flex-direction: column;
        gap: 15px;
        background: #fff8e1;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .note-editor.active {
        display: flex;
    }
    .note-editor textarea {
        width: calc(100% - 30px);
        height: 300px;
        padding: 15px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        resize: none;
        font-family: inherit;
        font-size: 1em;
        color: #1c1c1e;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
    }
    .editor-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .editor-buttons button {
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: #fff;
        transition: background 0.3s ease;
    }
    .save-note-button {
        background: linear-gradient(135deg, #28a745, #218838);
    }
    .save-note-button:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
    }
    .delete-note-button {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    .delete-note-button:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
    }
    .cancel-note-button {
        background: #6c757d;
    }
    .cancel-note-button:hover {
        background: #5a6268;
    }
    /* Image Albums Container Styles */
    .albums-container {
        width: 90%;
        max-width: 800px;
        height: 80vh;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .albums-container.active {
        display: flex;
    }
    .albums-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .albums-header h2 {
        margin: 0;
        color: #1c1c1e;
        font-size: 1.8em;
    }
    .albums-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex-grow: 1;
        background: rgba(240, 248, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 15px;
    }
    .album-item {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
    }
    .album-item:hover {
        background: rgba(255, 255, 255, 1);
    }
    .album-content {
        flex-grow: 1;
        font-size: 1.1em;
        padding-right: 10px;
    }
    .album-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        color: #666;
        transition: color 0.3s ease;
    }
    /* Album Creator & Viewer */
    .album-creator, .album-viewer {
        display: none;
        flex-direction: column;
        gap: 15px;
    }
    .album-creator.active, .album-viewer.active {
        display: flex;
    }
    .album-creator .album-name-input {
        width: calc(100% - 30px);
        padding: 15px;
        border: none;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.8);
        font-size: 1.2em;
        color: #1c1c1e;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
    }
    .image-picker-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        max-height: 400px;
        overflow-y: auto;
    }
    .image-picker-item {
        position: relative;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        transition: border 0.2s ease;
    }
    .image-picker-item img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 6px;
    }
    .image-picker-item.selected {
        border-color: #1E90FF;
    }
    .image-picker-item.selected::after {
        content: '‚úì';
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #1E90FF;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
    }
    /* Album Viewer */
    .album-viewer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        overflow-y: auto;
        padding: 15px;
        background: rgba(240, 248, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        flex-grow: 1;
    }
    .album-viewer-grid img {
        width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .album-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #1c1c1e;
        text-align: center;
        margin-bottom: 10px;
    }
    /* ----------------------------------------------------- */
    /* üí• –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† "–°–û–ó–î–ê–ù–ò–ï –ü–û–°–¢–ê/–ò–°–¢–û–†–ò–ò" üí• */
    .post-creator-container {
        width: 90%;
        max-width: 800px;
        height: 80vh;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5));
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .post-creator-container.active {
        display: flex;
    }
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .post-header h2 {
        margin: 0;
        color: #1c1c1e;
        font-size: 1.8em;
    }
    /* –ê–≤–∞—Ç–∞—Ä –∏ –ò–º—è/–ü—Å–µ–≤–¥–æ–Ω–∏–º */
    .post-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 16px;
        background: rgba(240, 248, 255, 0.4);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    #post-avatar-container {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 0 4px #8A2BE2, 0 0 0 8px #4169E1;
        overflow: hidden;
        background: #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #post-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        display: block;
    }
    #post-avatar-placeholder {
        position: absolute;
        font-size: 2.5em;
        color: #fff;
    }
    .post-user-details {
        flex-grow: 1;
    }
    /* –£–î–ê–õ–ï–ù–ê –°–¢–†–û–ö–ê –í–í–û–î–ê –ù–ê–ó–í–ê–ù–ò–Ø –ü–û–°–¢–ê */
    /* –í—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç–∞ */
    #post-image-selection {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background: rgba(240, 248, 255, 0.6);
        border-radius: 16px;
        margin-bottom: 15px;
    }
    #post-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
    }
    .post-image-item {
        position: relative;
        cursor: pointer;
        border: 3px solid transparent;
        border-radius: 10px;
        transition: border 0.3s ease;
        overflow: hidden;
        aspect-ratio: 1 / 1;
    }
    .post-image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 8px;
    }
    .post-image-item.selected {
        border-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.8);
    }
    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞ */
    #post-text-area {
        width: calc(100% - 30px);
        padding: 15px;
        height: 100px;
        border: none;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.8);
        resize: none;
        font-family: inherit;
        font-size: 1em;
        color: #1c1c1e;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
        margin-bottom: 15px;
    }
    /* –ö–Ω–æ–ø–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ */
    #publish-post-button {
        padding: 12px 25px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1.1em;
        color: #fff;
        background: linear-gradient(135deg, #1E90FF, #4682B4);
        font-weight: bold;
        transition: background 0.3s ease, transform 0.2s ease;
    }
    #publish-post-button:hover {
        background: linear-gradient(135deg, #104E8B, #1E90FF);
        transform: translateY(-1px);
    }
    /* --- –ö–æ–Ω–µ—Ü –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ --- */
    /* ----------------------------------------------------- */
    /* üí• –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –õ–ï–ù–¢–´ –ò–°–¢–û–†–ò–ô –ó–£–ë–† üí• */
    .story-feed-container {
        width: 90%;
        max-width: 800px;
        height: 80vh;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .story-feed-container.active {
        display: flex;
    }
    #story-feed-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex-grow: 1;
        background: rgba(240, 248, 255, 0.4);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 15px;
    }
    .story-post-item {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 16px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        transition: transform 0.2s ease;
    }
    .story-post-item:hover {
        transform: translateY(-2px);
    }
    .post-user-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding-bottom: 10px;
    }
    .post-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #1E90FF;
    }
    .post-username {
        font-weight: bold;
        font-size: 1.1em;
        color: #1c1c1e;
    }
    .post-image-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        margin-bottom: 15px;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
    }
    .post-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    /* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ü–†–û–°–ú–û–¢–†–ê –ü–†–û–ú–¢–ê */
    .view-prompt-button {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        display: none;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        color: #1c1c1e;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        z-index: 5;
    }
    .post-image-wrapper:hover .view-prompt-button {
        display: flex;
    }
    .view-prompt-button:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.1);
    }
    .post-image-overlay-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 15px;
        border: none;
        border-radius: 15px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        font-weight: bold;
        cursor: pointer;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease, background 0.3s ease;
        font-size: 1.1em;
        z-index: 10;
        pointer-events: all;
    }
    .post-image-wrapper.longpress .post-image-overlay-button {
        display: block;
        opacity: 1;
    }
    .post-text {
        font-size: 1em;
        line-height: 1.5;
        color: #333;
        white-space: pre-wrap;
    }
    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –°–í–û–ï–ì–û –ø–æ—Å—Ç–∞ */
    .delete-own-post-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 1.5em;
        transition: color 0.2s ease;
        z-index: 5;
    }
    .delete-own-post-button:hover {
        color: #c82333;
    }
    .report-count {
        position: absolute;
        bottom: 15px;
        right: 15px;
        font-size: 0.85em;
        color: #6c757d;
    }
    /* ----------------------------------------------------- */
    /* –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ü–†–û–ï–ö–¢–û–í */
    .project-container {
        width: 95%;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .project-container.active {
        display: flex;
    }
    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .project-header h2 {
        margin: 0;
        color: #1c1c1e;
        font-size: 1.8em;
    }
    .project-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        background: rgba(240, 248, 255, 0.4);
        padding: 15px;
        border-radius: 16px;
        backdrop-filter: blur(15px);
    }
    .toolbar-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-right: 20px;
    }
    .toolbar-section h4 {
        margin: 0 0 5px 0;
        font-size: 0.9em;
        color: #1c1c1e;
        opacity: 0.8;
    }
    .toolbar-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .toolbar-button {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 0.85em;
        color: #1c1c1e;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .toolbar-button:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-1px);
    }
    .toolbar-button.active {
        background: #1E90FF;
        color: white;
    }
    .color-option {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s ease;
    }
    .color-option:hover {
        transform: scale(1.2);
    }
    .color-option.selected {
        border-color: #1c1c1e;
        transform: scale(1.2);
    }
    .font-option {
        padding: 5px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .font-option:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    .font-option.selected {
        background: #1E90FF;
        color: white;
    }
    .project-canvas {
        flex: 1;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: crosshair;
    }
    .canvas-element {
        position: absolute;
        cursor: move;
        user-select: none;
        transition: box-shadow 0.3s ease;
    }
    .canvas-element.selected {
        box-shadow: 0 0 0 2px #1E90FF;
    }
    .canvas-element.text {
        padding: 5px;
        min-width: 50px;
        min-height: 20px;
        resize: none;
        border: none;
        outline: none;
        background: transparent;
        overflow: hidden;
        font-family: inherit;
        font-size: 1em;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .canvas-element.text:focus {
        background: rgba(255,255,255,0.9);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .canvas-element.image {
        object-fit: contain;
    }
    .canvas-element.shape {
        background: rgba(30, 144, 255, 0.7);
    }
    .element-controls {
        position: absolute;
        top: -30px;
        left: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 5px;
        display: none;
        gap: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
    }
    .canvas-element.selected .element-controls {
        display: flex;
    }
    .control-button {
        width: 25px;
        height: 25px;
        border: none;
        border-radius: 4px;
        background: rgba(30, 144, 255, 0.7);
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em;
        transition: background 0.3s ease;
    }
    .control-button:hover {
        background: #1E90FF;
    }
    .resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #1E90FF;
        border-radius: 50%;
        z-index: 10;
    }
    .resize-handle.top-left { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.top-right { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.bottom-left { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: se-resize; }
    .image-picker-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 300;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .image-picker-modal.active {
        display: flex;
        opacity: 1;
    }
    .image-picker-content {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(25px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    .image-picker-grid-modal {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
    }
    .image-picker-item-modal {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        transition: border 0.2s ease;
        aspect-ratio: 1 / 1;
        overflow: hidden;
    }
    .image-picker-item-modal img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 6px;
    }
    .image-picker-item-modal.selected {
        border-color: #1E90FF;
    }
    /* Show/Hide containers */
    .hidden {
        display: none;
        opacity: 0;
    }
    .visible {
        display: flex;
        opacity: 1;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(5px);}
      to {opacity: 1; transform: translateY(0);}
    }
    /* New styles for Test Dialog */
    .test-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 200;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .test-dialog-overlay.active {
        display: flex;
        opacity: 1;
    }
    .test-dialog-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(15px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        text-align: center;
        max-width: 400px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .test-dialog-box h3 {
        color: #1c1c1e;
        margin: 0;
        font-size: 1.5em;
    }
    .test-dialog-box p {
        color: #1c1c1e;
        font-size: 1.1em;
    }
    .test-dialog-box select,
    .test-dialog-box input[type="text"] {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.8);
        color: #1c1c1e;
        font-size: 1em;
        margin-bottom: 5px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .test-dialog-box select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%231c1c1e%22%20d%3D%22M287%20165.7c-4.3%204.3-11.4%204.3-15.7%200l-123%20-123L25.6%20165.7c-4.3%204.3-11.4%204.3-15.7%200-4.3-4.3-4.3-11.4%200-15.7l131.6-131.6c4.3-4.3%2011.4-4.3%2015.7%200l131.6%20131.6c4.3%204.3%204.3%2011.4%200%2015.7z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        cursor: pointer;
    }
    .test-dialog-box button {
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: white;
        background: #1E90FF;
        transition: background 0.3s ease;
    }
    .test-dialog-box button:hover {
        background: #104E8B;
    }
    /* NEW: Saved Tests Section in Test Dialog */
    .saved-tests-section {
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 15px;
        max-height: 200px;
        overflow-y: auto;
    }
    .saved-tests-section h4 {
        margin: 0 0 10px 0;
        font-size: 1.2em;
    }
    .saved-tests-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .saved-test-item {
        padding: 10px;
        background: rgba(240, 248, 255, 0.9);
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .saved-test-item:hover {
        background: rgba(240, 248, 255, 1);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–º—Ç–∞ */
    .prompt-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 300;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .prompt-modal-overlay.active {
        display: flex;
        opacity: 1;
    }
    .prompt-modal-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(25px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        text-align: center;
        max-width: 500px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .prompt-modal-box h3 {
        color: #1c1c1e;
        margin: 0;
        font-size: 1.5em;
    }
    .prompt-modal-text {
        background: rgba(255, 255, 255, 0.3);
        padding: 20px;
        border-radius: 15px;
        font-size: 1.1em;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
    }
    .prompt-modal-box button {
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: white;
        background: #1E90FF;
        transition: background 0.3s ease;
    }
    .prompt-modal-box button:hover {
        background: #104E8B;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è QR-–ö–û–î–ê */
    .qrcode-container {
        width: 95%;
        max-width: 1200px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        padding: 20px;
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        position: relative;
        z-index: 60;
    }
    .qrcode-container.active {
        display: flex;
    }
    .qrcode-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .qrcode-header h2 {
        margin: 0;
        color: #1c1c1e;
        font-size: 1.8em;
    }
    .qrcode-generator {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: rgba(240, 248, 255, 0.4);
        padding: 20px;
        border-radius: 16px;
        backdrop-filter: blur(15px);
    }
    .qrcode-input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .qrcode-input-group label {
        font-weight: bold;
        color: #1c1c1e;
    }
    .qrcode-input-group input, .qrcode-input-group select {
        width: calc(100% - 30px);
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: rgba(255, 255, 255, 0.8);
        font-size: 1em;
        color: #1c1c1e;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
    }
    .qrcode-options {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    .qrcode-color-picker, .qrcode-center-image {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        min-width: 200px;
    }
    .qrcode-color-preview {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 2px solid #1c1c1e;
        cursor: pointer;
        background: #000000;
    }
    .qrcode-center-image-preview {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        border: 2px dashed #1c1c1e;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        background: #f0f0f0;
        overflow: hidden;
    }
    .qrcode-center-image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
        border-radius: 6px;
    }
    .qrcode-center-image-preview i {
        font-size: 2em;
        color: #1c1c1e;
    }
    .qrcode-center-image-preview.has-image img {
        display: block;
    }
    .qrcode-center-image-preview.has-image i {
        display: none;
    }
    .qrcode-generate-button {
        padding: 15px 25px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1.1em;
        color: #fff;
        background: linear-gradient(135deg, #1E90FF, #4682B4);
        font-weight: bold;
        transition: background 0.3s ease, transform 0.2s ease;
        align-self: flex-start;
    }
    .qrcode-generate-button:hover {
        background: linear-gradient(135deg, #104E8B, #1E90FF);
        transform: translateY(-1px);
    }
    .qrcode-result {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .qrcode-result.active {
        display: flex;
    }
    .qrcode-display {
        max-width: 300px;
        max-height: 300px;
        border: 10px solid #1c1c1e;
        border-radius: 16px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    .qrcode-download-button {
        padding: 12px 25px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: #fff;
        background: linear-gradient(135deg, #28a745, #218838);
        font-weight: bold;
        transition: background 0.3s ease;
    }
    .qrcode-download-button:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è QR-–∫–æ–¥–∞ */
    .image-picker-modal-qrcode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 400;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .image-picker-modal-qrcode.active {
        display: flex;
        opacity: 1;
    }
    .image-picker-content-qrcode {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(25px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    .image-picker-grid-qrcode {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
    }
    .image-picker-item-qrcode {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        transition: border 0.2s ease;
        aspect-ratio: 1 / 1;
        overflow: hidden;
    }
    .image-picker-item-qrcode img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 6px;
    }
    .image-picker-item-qrcode.selected {
        border-color: #1E90FF;
    }
    /* File input for wallpaper */
    #wallpaper-upload-input {
      display: none;
    }
    /* NEW: Referral Program Overlay */
    .referral-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 500;
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    .referral-overlay.active {
        display: flex;
        opacity: 1;
    }
    .referral-box {
        background: linear-gradient(135deg, #1E90FF, #4682B4);
        color: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .referral-box h3 {
        margin: 0;
        font-size: 1.8em;
    }
    .referral-box p {
        font-size: 1.2em;
        margin: 10px 0;
    }
    .referral-link {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        font-size: 1.1em;
        word-break: break-all;
        margin: 10px 0;
    }
    .referral-link button {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background: #fff;
        color: #1E90FF;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.3s ease;
    }
    .referral-link button:hover {
        background: rgba(255, 255, 255, 0.9);
    }
    .referral-box button {
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: white;
        background: rgba(255, 255, 255, 0.2);
        transition: background 0.3s ease;
        font-weight: bold;
    }
    .referral-box button:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    /* New input for activation code */
    .activation-code-input {
        width: calc(100% - 30px);
        padding: 15px;
        border: none;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.8);
        color: #1c1c1e;
        font-size: 1.1em;
        margin-bottom: 5px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
    }
    .activation-code-input::placeholder {
        color: #999;
    }
    /* NEW: Bottom Navigation Buttons - Removed */
    .bottom-navigation {
        display: none; /* Hide bottom navigation as home button is removed and menu moved */
    }
    /* NEW: Secondary Menu Screen */
    .secondary-menu-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(25px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 200;
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    .secondary-menu-screen.active {
        display: flex;
        opacity: 1;
    }
    .secondary-menu-content {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(30px);
        padding: 40px;
        border-radius: 25px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        color: #1c1c1e;
        text-align: center;
        max-width: 600px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 25px;
    }
    .secondary-menu-content h2 {
        margin: 0;
        font-size: 2em;
        color: #1c1c1e;
    }
    .secondary-menu-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    .secondary-menu-button {
        padding: 20px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.8);
        color: #1c1c1e;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .secondary-menu-button:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .secondary-menu-button i {
        font-size: 2em;
    }
    .close-secondary-menu {
        align-self: flex-end;
        background: none;
        border: none;
        color: #1c1c1e;
        cursor: pointer;
        font-size: 2em;
        transition: color 0.3s ease;
    }
    .close-secondary-menu:hover {
        color: #1E90FF;
    }
    /* NEW: Custom Mode Settings Overlay */
    .custom-mode-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 300;
    }
    .custom-mode-overlay.active {
        display: flex;
    }
    .custom-mode-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(25px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        max-width: 500px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .custom-mode-box label {
        font-weight: bold;
    }
    .custom-mode-box select, .custom-mode-box input[type="text"] {
        padding: 10px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.8);
    }
    .custom-mode-box button {
        padding: 12px;
        border: none;
        border-radius: 20px;
        background: #1E90FF;
        color: white;
        cursor: pointer;
    }
    /* NEW: Music Composer Container */
    .music-composer-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(173, 216, 230, 0.8), rgba(255, 255, 255, 0.9));
        backdrop-filter: blur(20px);
        display: none;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        z-index: 300;
    }
    .music-composer-container.active {
        display: flex;
    }
    .instrument-select {
        margin-bottom: 20px;
    }
    .piano-keys {
        display: flex;
    }
    .key {
        width: 40px;
        height: 200px;
        border: 1px solid #ddd;
        margin: 2px;
        cursor: pointer;
        transition: all 0.1s;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: linear-gradient(to bottom, #fff 0%, #eee 100%);
    }
    .key.black {
        background: linear-gradient(to bottom, #333 0%, #000 100%);
        height: 120px;
        margin-left: -20px;
        margin-right: -20px;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .key:active {
        transform: scale(0.98);
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .music-controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .music-controls button {
        padding: 10px 20px;
        background: #1E90FF;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }
    .music-controls button:hover {
        background: #104E8B;
    }
    #music-message {
        margin-top: 10px;
        font-size: 1.2em;
        color: #1c1c1e;
    }
    .predefined-melodies {
        margin-top: 20px;
        width: 300px;
    }
    .predefined-melodies select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
    }
    .predefined-melodies button {
        width: 100%;
        padding: 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }
    .predefined-melodies button:hover {
        background: #218838;
    }
    /* Close button for music composer */
    #close-music-button {
        position: absolute;
        top: 30px;
        right: 30px;
        color: #1c1c1e;
        font-size: 2em;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .style-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 300;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .style-modal-overlay.active {
        display: flex;
        opacity: 1;
    }
    .style-modal-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(25px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        color: #1c1c1e;
        text-align: center;
        max-width: 500px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .style-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }
    .style-buttons button {
        padding: 12px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.8);
        color: #1c1c1e;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s ease;
    }
    .style-buttons button:hover {
        background: rgba(255, 255, 255, 1);
    }
    #close-style-modal {
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1em;
        color: white;
        background: #dc3545;
        transition: background 0.3s ease;
    }
    #close-style-modal:hover {
        background: #c82333;
    }
    /* NEW: Search Window Styles */
    #search-window {
      display: none;
      width: 189px; /* 5cm ‚âà 189px */
      height: 37.8px; /* 1cm ‚âà 37.8px */
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 5px;
      font-size: 0.8em;
      color: #1c1c1e;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: absolute;
      bottom: -45px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      line-height: 37.8px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    #search-window.active {
      display: block;
    }
    /* NEW: Magnifier Styles */
    #magnifier {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(5px);
      cursor: move;
      z-index: 999;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%);
    }
    #magnifier i {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2em;
    }
    .magnifier-hover {
      font-size: 2em !important;
      transition: font-size 0.2s;
    }
    /* NEW: Low Vision Mode Styles */
    body.low-vision {
      font-size: 2em !important;
    }
    body.low-vision * {
      font-size: inherit !important;
    }
    .cookie-consent-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.cookie-consent-overlay.active {
  display: flex;
}
.cookie-consent-box {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 15px;
  text-align: center;
  max-width: 400px;
}
    /* NEW: Image Modal Styles */
    .image-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .image-modal-overlay.active {
      display: flex;
      opacity: 1;
    }
    .image-modal-box {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(25px);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      color: #1c1c1e;
      text-align: center;
      max-width: 600px;
      width: 90%;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #modal-image {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    .image-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .image-modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      color: white;
      background: #1E90FF;
      transition: background 0.3s ease;
    }
    .image-modal-buttons button:hover {
      background: #104E8B;
    }
    /* NEW: Album Select Modal Styles */
    .album-select-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 310;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .album-select-overlay.active {
      display: flex;
      opacity: 1;
    }
    .album-select-box {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(25px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      color: #1c1c1e;
      max-width: 400px;
      width: 90%;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #album-select-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    .album-select-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }
    .album-select-item:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    .album-select-box button {
      padding: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      color: white;
      background: #1E90FF;
      transition: background 0.3s ease;
    }
    .album-select-box button:hover {
      background: #104E8B;
    }

/* Story Creator Modal */
.story-creator-overlay,
.story-viewer-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 600;
}
.story-creator-overlay.active,
.story-viewer-overlay.active {
  display: flex;
}
.story-creator-box,
.story-viewer-box {
  background: rgba(255,255,255,0.3);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 700px;
  color: #1c1c1e;
}
.story-creator-box h2,
.story-viewer-box h2 {
  margin-top: 0;
}
#story-prompt-input {
  width: 100%;
  height: 100px;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: rgba(255,255,255,0.8);
  margin: 10px 0 20px;
  resize: none;
}
.story-options {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}
.story-options div {
  flex: 1;
}
#generate-story-button,
#save-story-button,
#close-story-viewer-btn {
  padding: 12px 20px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #1E90FF, #4682B4);
  color: white;
  font-weight: bold;
  cursor: pointer;
}
#save-story-button {
  background: linear-gradient(135deg, #28a745, #218838);
}
.story-content {
  max-height: 60vh;
  overflow-y: auto;
  line-height: 1.6;
  padding: 15px;
  background: rgba(255,255,255,0.2);
  border-radius: 15px;
  margin-bottom: 20px;
}
.close-story-modal,
.close-story-viewer {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 1.8em;
  background: none;
  border: none;
  color: #1c1c1e;
  cursor: pointer;
}
.story-viewer-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

/* Story Loading Overlay */
.story-loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 650;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.story-loading-overlay.active {
  opacity: 1;
  pointer-events: all;
}
.story-loading-box {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(25px);
  padding: 30px 50px;
  border-radius: 20px;
  text-align: center;
  color: #1c1c1e;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}
.loading-spinner {
  font-size: 3em;
  margin-bottom: 20px;
  color: #1E90FF;
  animation: spin 1.2s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.story-loading-box p {
  font-size: 1.3em;
  margin: 0;
  font-weight: bold;
}

/* üéì –¶–∏—Ç–∞—Ç–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Ä–µ–∂–∏–º–æ–≤: —É—á–∏—Ç–µ–ª—å—Å–∫–∏–π, —à–∫–æ–ª—å–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π */
.chat-container[data-mode="teaching"] .assistant-message,
.chat-container[data-mode="school"] .assistant-message,
.chat-container[data-mode="professional"] .assistant-message {
  background: rgba(240, 248, 255, 0.4) !important;
  border-left: 4px solid #1E90FF !important;
  border-radius: 0 16px 16px 0 !important;
  padding: 16px 20px !important;
  margin-right: 10px !important;
  font-family: 'Georgia', serif !important;
  font-style: italic !important;
  line-height: 1.6 !important;
  color: #1c1c1e !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
  position: relative;
}

/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
.chat-container[data-mode="teaching"] .assistant-message::before,
.chat-container[data-mode="school"] .assistant-message::before,
.chat-container[data-mode="professional"] .assistant-message::before {
  content: "‚Äú";
  position: absolute;
  top: -10px;
  left: 10px;
  font-size: 3em;
  color: rgba(30, 144, 255, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
}

.chat-container[data-mode="teaching"] .assistant-message::after,
.chat-container[data-mode="school"] .assistant-message::after,
.chat-container[data-mode="professional"] .assistant-message::after {
  content: "‚Äù";
  position: absolute;
  bottom: -20px;
  right: 15px;
  font-size: 3em;
  color: rgba(30, 144, 255, 0.2);
  font-family: Georgia, serif;
  line-height: 1;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ—Å–∫–∞–∑–∞ */
.retell-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 700;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.retell-modal-overlay.active {
  display: flex;
  opacity: 1;
}
.retell-modal-box {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  color: #1c1c1e;
  text-align: left;
}
.retell-modal-box h3 {
  margin-top: 0;
  font-size: 1.6em;
  color: #1E90FF;
}
.retell-content {
  background: rgba(255, 255, 255, 0.8);
  padding: 20px;
  border-radius: 15px;
  margin: 20px 0;
  max-height: 60vh;
  overflow-y: auto;
  line-height: 1.6;
  font-size: 1.1em;
}
.retell-modal-box button {
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #1E90FF, #4682B4);
  color: white;
  font-weight: bold;
  cursor: pointer;
}
.retell-modal-box button:hover {
  background: linear-gradient(135deg, #104E8B, #1E90FF);
}
.close-retell-modal {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 1.8em;
  background: none;
  border: none;
  color: #1c1c1e;
  cursor: pointer;
}
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏ */
.emoji-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 300;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.emoji-modal-overlay.active {
  display: flex;
  opacity: 1;
}

.emoji-modal-box {
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  color: #1c1c1e;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.emoji-modal-box h3 {
  margin: 0;
  font-size: 1.8em;
  color: #1E90FF;
  text-align: center;
}

.close-emoji-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  color: #1c1c1e;
  cursor: pointer;
  font-size: 2em;
  transition: color 0.3s ease;
}

.close-emoji-modal:hover {
  color: #dc3545;
}

.emoji-input-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.emoji-input-group label {
  font-weight: bold;
  color: #1c1c1e;
}

.emoji-input-group textarea {
  width: calc(100% - 20px);
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: rgba(255, 255, 255, 0.8);
  font-size: 1em;
  color: #1c1c1e;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  outline: none;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

.emoji-style-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.emoji-style-group label {
  font-weight: bold;
  color: #1c1c1e;
}

.emoji-style-group select {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: rgba(255, 255, 255, 0.8);
  color: #1c1c1e;
  font-size: 1em;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  outline: none;
  cursor: pointer;
}

.emoji-generate-button {
  padding: 15px 25px;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 1.1em;
  color: #fff;
  background: linear-gradient(135deg, #FF6B6B, #FF8E53);
  font-weight: bold;
  transition: background 0.3s ease, transform 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.emoji-generate-button:hover {
  background: linear-gradient(135deg, #FF8E53, #FF6B6B);
  transform: translateY(-1px);
}

.emoji-result-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 16px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  min-height: 300px;
  position: relative;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
.emoji-loading {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 16px;
  z-index: 10;
  animation: fadeIn 0.3s ease;
}

.emoji-loading.active {
  display: flex;
}

.loading-spinner {
  font-size: 3em;
  color: #1E90FF;
  margin-bottom: 20px;
  animation: spin 1.5s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  font-size: 1.2em;
  font-weight: bold;
  color: #1c1c1e;
  margin-bottom: 10px;
  text-align: center;
}

.loading-subtext {
  font-size: 1em;
  color: #666;
  text-align: center;
  font-style: italic;
  margin-top: 10px;
}

.emoji-generated-image {
  max-width: 200px;
  max-height: 200px;
  border: 5px solid #1c1c1e;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  display: none;
}

.emoji-generated-image.active {
  display: block;
}

.emoji-generated-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  animation: fadeInScale 0.5s ease;
}

@keyframes fadeInScale {
  0% { opacity: 0; transform: scale(0.8); }
  100% { opacity: 1; transform: scale(1); }
}

.emoji-save-button {
  padding: 12px 25px;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 1em;
  color: #fff;
  background: linear-gradient(135deg, #28a745, #218838);
  font-weight: bold;
  transition: background 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.emoji-save-button:hover {
  background: linear-gradient(135deg, #218838, #1e7e34);
}

.saved-emojis-section {
  margin-top: 20px;
  background: rgba(255, 255, 255, 0.3);
  padding: 15px;
  border-radius: 15px;
}

.saved-emojis-section h4 {
  margin: 0 0 15px 0;
  font-size: 1.2em;
  text-align: center;
}

.saved-emojis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 10px;
  max-height: 200px;
  overflow-y: auto;
  padding: 10px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
}

.saved-emoji-item {
  width: 80px;
  height: 80px;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border 0.3s ease, transform 0.2s ease;
  position: relative;
}

.saved-emoji-item:hover {
  border-color: #1E90FF;
  transform: scale(1.05);
}

.saved-emoji-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.referral-prompt-content {
  text-align: center;
  padding: 30px 20px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 15px;
}

.referral-prompt-content h4 {
  font-size: 1.5em;
  margin-bottom: 15px;
  color: #dc3545;
}

.referral-prompt-content p {
  margin: 10px 0;
  font-size: 1.1em;
}
/* Welcome Modal Styles */
.welcome-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.65);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
.welcome-modal-overlay.active {
  opacity: 1;
  pointer-events: all;
}
.welcome-modal-box {
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.9), rgba(70, 130, 180, 0.85));
  color: white;
  padding: 30px 40px;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  max-width: 400px;
  width: 90%;
  animation: fadeInScale 0.6s ease-out;
}
.welcome-modal-box h2 {
  margin: 0 0 15px 0;
  font-size: 1.8em;
}
.welcome-modal-box p {
  margin: 0;
  font-size: 1.2em;
  font-weight: 500;
}
@keyframes fadeInScale {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
  </style>
</head>
<body>
  <audio id="background-music" loop></audio>
  <div class="top-bar" id="top-bar">
    <div class="top-buttons">
        <button id="menu-toggle-button" class="menu-button">
          <i class="fas fa-bars"></i>
        </button>
        <button id="wallpaper-button" title="–ò–∑–º–µ–Ω–∏—Ç—å –æ–±–æ–∏">
          <i class="fas fa-image"></i>
        </button>
        <input type="file" id="wallpaper-upload-input" accept="image/*,video/*" />
    </div>
    <div class="right-container">
      <div id="weather-widget" class="weather-widget default">
        <span id="weather-emoji" class="weather-emoji">...</span>
        <span id="weather-temp" class="weather-temp">...</span>
      </div>
      <button id="universal-menu-button" class="universal-menu-button" title="–ú–µ–Ω—é">
        <i class="fas fa-th-large"></i>
      </button>
    </div>
  </div>
  <div id="chat-menu" class="chat-menu">
    <div class="menu-header">
      <h3>–ú–µ–Ω—é</h3>
      <div class="menu-buttons">
        <button id="new-chat-button" class="new-chat-button">
          <i class="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç
        </button>
        <button id="albums-menu-button" class="albums-menu-button">
            <i class="fas fa-camera"></i> –ê–ª—å–±–æ–º—ã
        </button>
        <button id="low-vision-button">
            <i class="fas fa-eye-low-vision"></i> –†–µ–∂–∏–º –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö
        </button>
        <button id="project-menu-button">
            <i class="fas fa-palette"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
        </button>
        <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø QR-–ö–û–î–ê -->
        <button id="qrcode-menu-button">
            <i class="fas fa-qrcode"></i> –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥
        </button>
        <div id="language-menu-item">
            <span>–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫</span>
            <i class="fas fa-globe"></i>
            <div id="language-submenu" class="language-submenu">
                <button type="button" data-lang="ru">–û–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</button>
                <button type="button" data-lang="be">–û–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</button>
                <button type="button" data-lang="en">–û–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ</button>
                <button type="button" data-lang="zh">–û–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–æ–º —è–∑—ã–∫–µ</button>
                <button type="button" data-lang="es">–û–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –Ω–∞ –∏—Å–ø–∞–Ω—Å–∫–æ–º —è–∑—ã–∫–µ</button>
            </div>
        </div>
        </div>
    </div>
    <button id="speak-toggle-button" class="speak-button">
        <i class="fas fa-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
    </button>
    <ul id="chat-list" class="chat-list">
      </ul>
  </div>
  <div class="microphone-overlay" id="microphone-overlay">
    <div class="mic-controls">
      <button id="color-picker-button" class="color-picker-button">
        <i class="fas fa-tint"></i>
      </button>
      <div id="color-picker-menu" class="color-picker-menu">
        <button id="set-white-background-button">
            <i class="fas fa-circle" style="color: #fff;"></i> –ë–µ–ª—ã–π —Ñ–æ–Ω
        </button>
        <button id="upload-image-button">
            <i class="fas fa-image"></i> –°–≤–æ—ë —Ñ–æ—Ç–æ
        </button>
        <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
      </div>
      <!-- NEW: Language selector button -->
      <button id="language-picker-button" class="color-picker-button">
        <i class="fas fa-globe"></i>
      </button>
      <div id="mic-language-select" class="mic-language-select">
        <select id="mic-language-dropdown">
          <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
          <option value="en-US">English</option>
          <option value="zh-CN">‰∏≠Êñá</option>
          <option value="es-ES">Espa√±ol</option>
          <option value="be-BY">–ë–µ–ª–∞—Ä—É—Å–∫–∞—è</option>
        </select>
      </div>
    </div>
    <button id="mic-close-button" class="mic-close-button">&times;</button>
    <div class="wave-container">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>
    <div class="mic-instructions">–ì–æ–≤–æ—Ä–∏—Ç–µ...</div>
    <div class="subtitle-box" id="subtitle-box"></div>
  </div>
  <div class="chat-container" id="chat-container">
    <div class="chat-box"></div>
    <form class="input-container" id="chat-form">
      <div class="menu-dropdown">
        <button type="button" id="input-menu-button" class="input-menu-button">
          <i class="fas fa-plus"></i>
        </button>
        <div id="input-dropdown-menu" class="dropdown-menu">
            <button type="button" class="menu-item" id="generate-image-button">
                <span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                <i class="fas fa-image"></i>
            </button>
         <!-- –í–Ω—É—Ç—Ä–∏ #input-dropdown-menu –¥–æ–±–∞–≤—å—Ç–µ: -->
<button type="button" class="menu-item" id="create-emoji-button">
    <span>–°–æ–∑–¥–∞—Ç—å —ç–º–æ–¥–∑–∏</span>
    <i class="fas fa-smile"></i>
</button> 
            <button type="button" class="menu-item" id="take-test-button">
                <span>–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</span>
                <i class="fas fa-pencil-alt"></i>
            </button>
            <button type="button" class="menu-item" id="world-map-button">
                <span>–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</span>
                <i class="fas fa-globe"></i>
            </button>
            <div class="menu-item" id="modes-menu-item">
                <span>–†–µ–∂–∏–º—ã</span>
                <i class="fas fa-chevron-right"></i>
                <div id="modes-submenu" class="modes-submenu">
                    <button type="button" class="mode-button active-mode" data-mode="standard">
                        <span>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span>
                        <i class="fas fa-check"></i>
                    </button>
                    <button type="button" class="mode-button" data-mode="school">
                        <span>–®–∫–æ–ª—å–Ω—ã–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="professional">
                        <span>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="teaching">
                        <span>–£—á–∏—Ç–µ–ª—å—Å–∫–∏–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="literary">
                        <span>–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="search">
                        <span>–ü–æ–∏—Å–∫–æ–≤–æ–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="casual">
                        <span>–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π</span>
                    </button>
                    <button type="button" class="mode-button" data-mode="custom">
                        <span>–ö–∞—Å—Ç–æ–º–Ω—ã–π</span>
                    </button>
                </div>
            </div>
        </div>
      </div>
      <input type="text" id="prompt-input" name="prompt" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." required>
      <div id="search-window">–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>
      <button type="button" id="mic-toggle-button" class="mic-button">
        <i class="fas fa-microphone"></i>
      </button>
      <button type="submit" class="input-button"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>
  <div class="notes-container" id="notes-container">
    <div class="notes-header">
        <h2>–ú–æ–∏ –ó–∞–º–µ—Ç–∫–∏</h2>
        <div class="notes-header-buttons">
            <button id="add-note-button" class="add-note-button">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞
            </button>
            <button id="back-to-chat-button" class="back-to-chat-button">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>
    <ul id="notes-list" class="notes-list"></ul>
    <div id="note-editor" class="note-editor">
        <textarea id="note-text-area" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞–º–µ—Ç–∫—É –∑–¥–µ—Å—å..."></textarea>
        <div class="editor-buttons">
            <button id="save-note-button" class="save-note-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="delete-note-button" class="delete-note-button hidden">–£–¥–∞–ª–∏—Ç—å</button>
            <button id="cancel-note-button" class="cancel-note-button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
  </div>
  <div class="albums-container" id="albums-container">
      <div class="albums-header">
          <h2>–ú–æ–∏ –ê–ª—å–±–æ–º—ã</h2>
          <div class="notes-header-buttons">
              <button id="add-album-button" class="add-note-button" style="background: rgba(147, 112, 219, 0.8); color: #fff;">
                  <i class="fas fa-plus"></i> –ù–æ–≤—ã–π –∞–ª—å–±–æ–º
              </button>
              <button id="back-to-chat-from-albums-button" class="back-to-chat-button">
                  <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
              </button>
          </div>
      </div>
      <ul id="albums-list" class="albums-list active"></ul>
      <div id="album-creator" class="album-creator">
          <input type="text" id="album-name-input" class="album-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞" />
          <div id="image-picker-grid" class="image-picker-grid"></div>
          <div class="editor-buttons">
              <button id="save-album-button" class="save-note-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel-album-button" class="cancel-note-button">–û—Ç–º–µ–Ω–∞</button>
          </div>
      </div>
      <div id="album-viewer" class="album-viewer">
          <h3 id="album-viewer-title" class="album-title"></h3>
          <div id="album-viewer-grid" class="album-viewer-grid"></div>
          <div class="editor-buttons">
              <button id="delete-album-button" class="delete-note-button">–£–¥–∞–ª–∏—Ç—å</button>
              <button id="back-to-albums-list-button" class="cancel-note-button">–ù–∞–∑–∞–¥ –∫ –∞–ª—å–±–æ–º–∞–º</button>
          </div>
      </div>
  </div>
  <div class="post-creator-container" id="post-creator-container">
    <div class="post-header">
        <button id="back-to-feed-button" class="back-to-chat-button">
            <i class="fas fa-arrow-left"></i> –ö –õ–µ–Ω—Ç–µ
        </button>
        <h2>–°–æ–∑–¥–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é —Å –ó–£–ë–†</h2>
        <span></span>
    </div>
    <div class="post-user-info">
        <div id="post-avatar-container">
            <img id="post-avatar" src="" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä" style="display:none;">
            <i id="post-avatar-placeholder" class="fas fa-user"></i>
        </div>
        <div class="post-user-details">
            <input type="text" id="post-name-input" placeholder="–í–∞—à–µ –∏–º—è/–ø—Å–µ–≤–¥–æ–Ω–∏–º" value="–ó–£–ë–† –§–∞–Ω" />
            <button id="select-avatar-button" class="add-note-button" style="background: #4169E1; color: #fff; padding: 5px 10px; font-size: 0.9em; margin-top: 5px;">
                <i class="fas fa-image"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
            </button>
            <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
        </div>
    </div>
    <div id="post-image-selection">
        <h3 style="margin-top: 0; font-size: 1.2em;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –ê–ª—å–±–æ–º–æ–≤ –ó–£–ë–† –ò–ò:</h3>
        <div id="post-images-grid">
            </div>
    </div>
    <textarea id="post-text-area" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –ø–æ—Å—Ç–∞ –∑–¥–µ—Å—å..."></textarea>
    <button id="publish-post-button">
        <i class="fas fa-paper-plane"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é
    </button>
  </div>
  <div class="story-feed-container" id="story-feed-container">
    <div class="notes-header">
        <h2>–ò—Å—Ç–æ—Ä–∏–∏ —Å –ó–£–ë–†</h2>
        <div class="notes-header-buttons">
            <button id="go-to-creator-button" class="add-note-button" style="background: #28a745; color: #fff;">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ü–æ—Å—Ç
            </button>
            <button id="back-to-chat-from-feed-button" class="back-to-chat-button">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>
    <ul id="story-feed-list">
        </ul>
  </div>
  <div class="project-container" id="project-container">
    <div class="project-header">
        <h2>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h2>
        <div class="notes-header-buttons">
            <button id="save-project-button" class="add-note-button" style="background: #28a745; color: #fff;">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
            </button>
            <button id="back-to-chat-from-project-button" class="back-to-chat-button">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>
    <div class="project-toolbar">
        <div class="toolbar-section">
            <h4>–≠–ª–µ–º–µ–Ω—Ç—ã</h4>
            <div class="toolbar-buttons">
                <button class="toolbar-button" id="add-text-button">
                    <i class="fas fa-font"></i> –¢–µ–∫—Å—Ç
                </button>
                <button class="toolbar-button" id="add-image-button">
                    <i class="fas fa-image"></i> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
                <button class="toolbar-button" id="add-shape-button">
                    <i class="fas fa-square"></i> –§–∏–≥—É—Ä–∞
                </button>
            </div>
        </div>
        <div class="toolbar-section">
            <h4>–®—Ä–∏—Ñ—Ç—ã</h4>
            <div class="toolbar-buttons">
                <button class="toolbar-button font-option" data-font="Arial, sans-serif">Arial</button>
                <button class="toolbar-button font-option" data-font="'Times New Roman', serif">Times</button>
                <button class="toolbar-button font-option" data-font="'Courier New', monospace">Courier</button>
                <button class="toolbar-button font-option" data-font="'Georgia', serif">Georgia</button>
                <button class="toolbar-button font-option" data-font="'Verdana', sans-serif">Verdana</button>
            </div>
        </div>
        <div class="toolbar-section">
            <h4>–¶–≤–µ—Ç–∞</h4>
            <div class="toolbar-buttons">
                <div class="color-option" style="background: #FF6B6B;" data-color="#FF6B6B"></div>
                <div class="color-option" style="background: #4ECDC4;" data-color="#4ECDC4"></div>
                <div class="color-option" style="background: #FFD166;" data-color="#FFD166"></div>
                <div class="color-option" style="background: #06D6A0;" data-color="#06D6A0"></div>
                <div class="color-option" style="background: #118AB2;" data-color="#118AB2"></div>
                <div class="color-option" style="background: #073B4C;" data-color="#073B4C"></div>
                <div class="color-option" style="background: #FFFFFF;" data-color="#FFFFFF"></div>
                <div class="color-option" style="background: #000000;" data-color="#000000"></div>
            </div>
        </div>
        <div class="toolbar-section">
            <h4>–§–∏–≥—É—Ä—ã</h4>
            <div class="toolbar-buttons">
                <button class="toolbar-button shape-option" data-shape="rectangle">
                    <i class="fas fa-square"></i>
                </button>
                <button class="toolbar-button shape-option" data-shape="circle">
                    <i class="fas fa-circle"></i>
                </button>
                <button class="toolbar-button shape-option" data-shape="triangle">
                    <i class="fas fa-play"></i>
                </button>
                <button class="toolbar-button shape-option" data-shape="star">
                    <i class="fas fa-star"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="project-canvas" id="project-canvas">
    </div>
  </div>
  <!-- –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø QR-–ö–û–î–ê -->
  <div class="qrcode-container" id="qrcode-container">
    <div class="qrcode-header">
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ QR-–∫–æ–¥–∞</h2>
        <div class="notes-header-buttons">
            <button id="save-qrcode-button" class="add-note-button" style="background: #1E90FF; color: #fff;">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å QR-–∫–æ–¥
            </button>
            <button id="back-to-chat-from-qrcode-button" class="back-to-chat-button">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>
    <div class="qrcode-generator" id="qrcode-generator">
        <div class="qrcode-input-group">
            <label for="qrcode-url-input">–í–≤–µ–¥–∏—Ç–µ URL –∏–ª–∏ —Ç–µ–∫—Å—Ç:</label>
            <input type="text" id="qrcode-url-input" placeholder="https://example.com –∏–ª–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç" />
        </div>
        <div class="qrcode-options">
            <div class="qrcode-color-picker">
                <label for="qrcode-color-picker">–¶–≤–µ—Ç QR-–∫–æ–¥–∞:</label>
                <input type="color" id="qrcode-color-picker" value="#000000" />
                <div class="qrcode-color-preview" id="qrcode-color-preview" style="background: #000000;"></div>
            </div>
            <div class="qrcode-center-image">
                <label for="qrcode-center-image-preview">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä–µ:</label>
                <div class="qrcode-center-image-preview" id="qrcode-center-image-preview">
                    <i class="fas fa-image"></i>
                    <img id="qrcode-center-image-img" src="" alt="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                </div>
            </div>
        </div>
        <button class="qrcode-generate-button" id="qrcode-generate-button">
            <i class="fas fa-qrcode"></i> –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥
        </button>
    </div>
    <div class="qrcode-result" id="qrcode-result">
        <div id="qrcode-display" class="qrcode-display"></div>
        <button class="qrcode-download-button" id="qrcode-download-button">
            <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å QR-–∫–æ–¥
        </button>
    </div>
  </div>
  <div class="image-picker-modal" id="image-picker-modal">
    <div class="image-picker-content">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞</h3>
        <div id="image-picker-grid-modal" class="image-picker-grid-modal">
        </div>
        <div class="editor-buttons">
            <button id="confirm-image-selection" class="save-note-button">–í—ã–±—Ä–∞—Ç—å</button>
            <button id="cancel-image-selection" class="cancel-note-button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è QR-–∫–æ–¥–∞ -->
  <div class="image-picker-modal-qrcode" id="image-picker-modal-qrcode">
    <div class="image-picker-content-qrcode">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–≤–æ–∏—Ö –∞–ª—å–±–æ–º–æ–≤</h3>
        <div id="image-picker-grid-qrcode" class="image-picker-grid-qrcode">
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
        </div>
        <div class="editor-buttons">
            <button id="confirm-image-selection-qrcode" class="save-note-button">–í—ã–±—Ä–∞—Ç—å</button>
            <button id="cancel-image-selection-qrcode" class="cancel-note-button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
  </div>
  <div class="test-dialog-overlay" id="test-dialog-overlay">
      <div class="test-dialog-box">
          <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫–ª–∞—Å—Å, –ø—Ä–µ–¥–º–µ—Ç –∏ —Ç–µ–º—É –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.</p>
          <select id="class-select">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å...</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
          </select>
          <select id="subject-select">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</option>
              <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
              <option value="–§–∏–∑–∏–∫–∞">–§–∏–∑–∏–∫–∞</option>
              <option value="–•–∏–º–∏—è">–•–∏–º–∏—è</option>
              <option value="–ë–∏–æ–ª–æ–≥–∏—è">–ë–∏–æ–ª–æ–≥–∏—è</option>
              <option value="–ò—Å—Ç–æ—Ä–∏—è">–ò—Å—Ç–æ—Ä–∏—è</option>
              <option value="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
              <option value="–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
              <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
          </select>
          <select id="section-select">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)...</option>
              <option value="–í–≤–µ–¥–µ–Ω–∏–µ">–í–≤–µ–¥–µ–Ω–∏–µ</option>
              <option value="–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å">–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å</option>
              <option value="–ó–∞–∫–ª—é—á–µ–Ω–∏–µ/–ò—Ç–æ–≥–∏">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ/–ò—Ç–æ–≥–∏</option>
              <option value="–õ—é–±–æ–π">–õ—é–±–æ–π</option>
          </select>
          <input type="text" id="topic-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è'..." />
          <button id="start-test-button">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
          <!-- NEW: Saved Tests Section -->
          <div class="saved-tests-section">
            <h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã</h4>
            <ul id="saved-tests-list" class="saved-tests-list"></ul>
          </div>
      </div>
  </div>
  <div class="prompt-modal-overlay" id="prompt-modal-overlay">
      <div class="prompt-modal-box">
          <h3>–ü—Ä–æ–º—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
          <div id="prompt-modal-text" class="prompt-modal-text">
              –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–æ–º—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
          </div>
          <button id="close-prompt-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
  </div>
  <!-- NEW: Image Action Modal -->
  <div class="image-modal-overlay" id="image-modal-overlay">
    <div class="image-modal-box">
      <img id="modal-image" src="" alt="Generated Image">
      <div class="image-modal-buttons">
        <button id="show-prompt-btn">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
        <button id="save-to-album-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∞–ª—å–±–æ–º</button>
      </div>
    </div>
  </div>
  <!-- NEW: Album Select Modal for Single Image -->
  <div class="album-select-overlay" id="album-select-overlay">
    <div class="album-select-box">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª—å–±–æ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</h3>
      <ul id="album-select-list"></ul>
      <button id="create-new-album-for-image">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º</button>
      <button id="cancel-album-select">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
  <!-- NEW: Referral Program Overlay -->
  <div class="referral-overlay" id="referral-overlay">
      <div class="referral-box">
          <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
          <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥–≤—É—Ö –¥—Ä—É–∑–µ–π –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –ø–æ–¥ —Å–µ–±—è.</p>
          <div class="referral-link">
              <p>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</p>
              <p id="referral-link-text">https://techvision2025qwerty.github.io/zubrmax.github.io/</p>
              <button id="copy-link-button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          </div>
          <p>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:</p>
          <input type="text" id="activation-code-input" class="activation-code-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏..." />
          <button id="activate-code-button">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
          <button id="close-referral-button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
  </div>
  <!-- NEW: Secondary Menu Screen -->
  <div class="secondary-menu-screen" id="secondary-menu-screen">
      <div class="secondary-menu-content">
          <button class="close-secondary-menu" id="close-secondary-menu">&times;</button>
          <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h2>
          <div class="secondary-menu-buttons">
              <button class="secondary-menu-button" id="secondary-low-vision-button">
                  <i class="fas fa-eye-low-vision"></i>
                  <span>–†–µ–∂–∏–º –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö</span>
              </button>
              <button class="secondary-menu-button" id="secondary-qrcode-button">
                  <i class="fas fa-qrcode"></i>
                  <span>–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</span>
              </button>
              <button class="secondary-menu-button" id="secondary-project-button">
                  <i class="fas fa-palette"></i>
                  <span>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</span>
              </button>
              <button class="secondary-menu-button" id="secondary-notes-button">
                  <i class="fas fa-sticky-note"></i>
                  <span>–ó–∞–º–µ—Ç–∫–∏</span>
              </button>
              <button class="secondary-menu-button" id="secondary-music-button">
                  <i class="fas fa-music"></i>
                  <span>–ù–∞–ø–∏—Å–∞—Ç—å –º—É–∑—ã–∫—É</span>
              </button>
<button class="secondary-menu-button" id="secondary-story-button">
  <i class="fas fa-book-open"></i>
  <span>–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å–∫–∞–∑</span>
</button>

          </div>
      </div>
  </div>
  <!-- NEW: Custom Mode Settings Overlay -->
  <div class="custom-mode-overlay" id="custom-mode-overlay">
      <div class="custom-mode-box">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞</h3>
          <label>–¢–æ–Ω –æ–±—â–µ–Ω–∏—è:</label>
          <select id="tone-select">
              <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
              <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
              <option value="casual">–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π</option>
          </select>
          <label>–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤:</label>
          <select id="speed-select">
              <option value="fast">–ë—ã—Å—Ç—Ä–∞—è</option>
              <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
              <option value="slow">–ú–µ–¥–ª–µ–Ω–Ω–∞—è</option>
          </select>
          <label>–î–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤:</label>
          <select id="detail-select">
              <option value="low">–ù–∏–∑–∫–∞—è</option>
              <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
              <option value="high">–í—ã—Å–æ–∫–∞—è</option>
          </select>
          <label>–ù–∞ —á—Ç–æ –æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:</label>
          <input type="text" id="focus-input" placeholder="e.g. –§–∞–∫—Ç—ã, —é–º–æ—Ä">
          <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</label>
          <input type="text" id="additional-input" placeholder="e.g. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏, —Å—Å—ã–ª–∫–∏">
          <button id="save-custom-mode">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
  </div>
  <!-- NEW: Music Composer Container -->
  <div class="music-composer-container" id="music-composer-container">
      <button id="close-music-button" class="mic-close-button">&times;</button>
      <h2>–ù–∞–ø–∏—Å–∞—Ç—å –º—É–∑—ã–∫—É</h2>
      <select class="instrument-select" id="instrument-select">
          <option value="piano">–ü–∏–∞–Ω–∏–Ω–æ</option>
          <option value="guitar">–ì–∏—Ç–∞—Ä–∞</option>
          <option value="drums">–ë–∞—Ä–∞–±–∞–Ω—ã</option>
      </select>
      <div class="piano-keys" id="piano-keys">
          <!-- –ö–ª–∞–≤–∏—à–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
      </div>
      <div class="music-controls">
          <button id="start-record">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button id="pause-record" style="display: none;">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button id="set-to-main" style="display: none;">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
      </div>
      <div id="music-message"></div>
      <div class="predefined-melodies">
          <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –º–µ–ª–æ–¥–∏—é</h3>
          <select id="melody-select">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
              <option value="twinkle">Twinkle Twinkle Little Star</option>
              <option value="ode">Ode to Joy</option>
              <option value="rowboat">Row Row Row Your Boat</option>
          </select>
          <button id="play-melody">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
          <button id="set-melody-to-main">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
      </div>
  </div>
  <!-- NEW: Style Selection Modal -->
  <div class="style-modal-overlay" id="style-modal-overlay">
      <div class="style-modal-box">
          <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
          <div class="style-buttons">
              <button data-style="–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π">–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</button>
              <button data-style="–ê–Ω–∏–º–µ">–ê–Ω–∏–º–µ</button>
              <button data-style="–ö–∞—Ä–∏–∫–∞—Ç—É—Ä–∞">–ö–∞—Ä–∏–∫–∞—Ç—É—Ä–∞</button>
              <button data-style="–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π">–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π</button>
              <button data-style="–í–æ–¥—è–Ω—ã–µ –∫—Ä–∞—Å–∫–∏">–í–æ–¥—è–Ω—ã–µ –∫—Ä–∞—Å–∫–∏</button>
              <button data-style="–ú–∞—Å–ª—è–Ω–∞—è –∂–∏–≤–æ–ø–∏—Å—å">–ú–∞—Å–ª—è–Ω–∞—è –∂–∏–≤–æ–ø–∏—Å—å</button>
              <button data-style="–ü–∏–∫—Å–µ–ª—å-–∞—Ä—Ç">–ü–∏–∫—Å–µ–ª—å-–∞—Ä—Ç</button>
              <button data-style="–ö–∏–±–µ—Ä–ø–∞–Ω–∫">–ö–∏–±–µ—Ä–ø–∞–Ω–∫</button>
              <button data-style="–§—ç–Ω—Ç–µ–∑–∏">–§—ç–Ω—Ç–µ–∑–∏</button>
              <button data-style="–°—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π">–°—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</button>
          </div>
          <button id="close-style-modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
  </div>
  <!-- NEW: Magnifier Element -->
  <div id="magnifier">
    <i class="fas fa-search-plus"></i>
  </div>
<div id="cookie-consent-overlay" class="cookie-consent-overlay">
  <div class="cookie-consent-box">
    <h3>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ cookies </h3>
    <p>–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookies  –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö, —á–∞—Ç–æ–≤, –∑–∞–º–µ—Ç–æ–∫ –∏ —Ç.–¥.</p>
    <p>–ü—Ä–∏–Ω—è—Ç—å –∫—É–∫–∏?</p>
    <button id="accept-cookies">–î–∞</button>
    <button id="reject-cookies">–ù–µ—Ç</button>
  </div>
</div>

<!-- Story Creator Modal -->
<div class="story-creator-overlay" id="story-creator-overlay">
  <div class="story-creator-box">
    <button class="close-story-modal">&times;</button>
    <h2>–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å–∫–∞–∑</h2>
    <p>–û–ø–∏—à–∏—Ç–µ, –æ —á—ë–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞—Å—Å–∫–∞–∑:</p>
    <textarea id="story-prompt-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–†–∞—Å—Å–∫–∞–∑ –æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è—Ö —â–µ–Ω–∫–∞ –≤ –≤–æ–ª—à–µ–±–Ω–æ–º –ª–µ—Å—É...'"></textarea>
    
    <div class="story-options">
      <div>
        <label>–®—Ä–∏—Ñ—Ç:</label>
        <select id="story-font-select">
          <option value="Arial, sans-serif">Arial</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="'Georgia', serif">Georgia</option>
          <option value="'Verdana', sans-serif">Verdana</option>
        </select>
      </div>
      <div>
        <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
        <input type="color" id="story-color-picker" value="#1c1c1e" />
      </div>
    </div>
    
    <button id="generate-story-button">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å–∫–∞–∑</button>
  </div>
</div>

<!-- Story Viewer Modal -->
<div class="story-viewer-overlay" id="story-viewer-overlay">
  <div class="story-viewer-box">
    <button class="close-story-viewer">&times;</button>
    <div id="story-content" class="story-content"></div>
    <div class="story-viewer-actions">
      <button id="save-story-button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑</button>
      <button id="close-story-viewer-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Story Loading Overlay -->
<div class="story-loading-overlay" id="story-loading-overlay">
  <div class="story-loading-box">
    <div class="loading-spinner">
      <i class="fas fa-spinner"></i>
    </div>
    <p>–ü–æ–¥–æ–∂–¥–∏—Ç–µ, —Ä–∞—Å—Å–∫–∞–∑ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</p>
  </div>
</div>
<!-- –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å–∫–∞–∑–∞—Ç—å" –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –∫–∞–∂–¥—É—é –∑–∞–º–µ—Ç–∫—É -->
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Å–∫–∞–∑–∞ -->
<div class="retell-modal-overlay" id="retell-modal-overlay">
  <div class="retell-modal-box">
    <button class="close-retell-modal">&times;</button>
    <h3>–ü–µ—Ä–µ—Å–∫–∞–∑ –∑–∞–º–µ—Ç–∫–∏</h3>
    <div id="retell-content" class="retell-content"></div>
    <button id="close-retell-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏ -->
<div class="emoji-modal-overlay" id="emoji-modal-overlay">
  <div class="emoji-modal-box">
    <button class="close-emoji-modal">&times;</button>
    <h3>–°–æ–∑–¥–∞—Ç—å –≠–º–æ–¥–∑–∏</h3>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π -->
    <div id="emoji-creator-interface">
      <div class="emoji-input-group">
        <label for="emoji-description">–û–ø–∏—à–∏—Ç–µ —ç–º–æ–¥–∑–∏:</label>
        <textarea id="emoji-description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–∏–ª–∞—è –∫–æ—à–∫–∞ —Å –±–æ–ª—å—à–∏–º–∏ –≥–ª–∞–∑–∞–º–∏ –∏ —É–ª—ã–±–∫–æ–π" rows="3"></textarea>
      </div>
      
      <div class="emoji-style-group">
        <label for="emoji-style-select">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:</label>
        <select id="emoji-style-select">
          <option value="—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π">–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>
          <option value="–º—É–ª—å—Ç—è—à–Ω—ã–π">–ú—É–ª—å—Ç—è—à–Ω—ã–π</option>
          <option value="–ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç">–ü–∏–∫—Å–µ–ª—å-–∞—Ä—Ç</option>
          <option value="–∞–Ω–∏–º–µ">–ê–Ω–∏–º–µ</option>
          <option value="–º–∏–ª—ã–π">–ú–∏–ª—ã–π (–∫–∞–≤–∞–π–Ω—ã–π)</option>
          <option value="–≥–µ–π–º–∏–Ω–≥">–ò–≥—Ä–æ–≤–æ–π —Å—Ç–∏–ª—å</option>
          <option value="3D">3D —Ä–µ–Ω–¥–µ—Ä</option>
          <option value="–ø–ª–æ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω">–ü–ª–æ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω</option>
        </select>
      </div>
      
      <button id="generate-emoji-button" class="emoji-generate-button">
        <i class="fas fa-magic"></i> –°–æ–∑–¥–∞—Ç—å —ç–º–æ–¥–∑–∏
      </button>
      
      <!-- –û–±–ª–∞—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
      <div class="emoji-result-area" id="emoji-result-area">
        <!-- –≠–ª–µ–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="emoji-loading" id="emoji-loading">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <p class="loading-text">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è...</p>
          <p class="loading-subtext">–ü—Ä–∏–≤–µ—Ç! üòä –≠–º–æ–¥–∑–∏ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤...</p>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div id="emoji-generated-image" class="emoji-generated-image"></div>
        
        <button id="save-emoji-button" class="emoji-save-button" style="display: none;">
          <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–º–æ–¥–∑–∏
        </button>
      </div>
      
      <!-- –õ–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —ç–º–æ–¥–∑–∏ -->
      <div class="saved-emojis-section">
        <h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏</h4>
        <div id="saved-emojis-grid" class="saved-emojis-grid">
          <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
      </div>
    </div>
    
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
    <div id="emoji-referral-prompt" style="display: none;">
      <div class="referral-prompt-content">
        <h4>üîí –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h4>
        <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É</p>
        <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥–≤—É—Ö –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏!</p>
        <button id="open-referral-from-emoji" class="emoji-generate-button">
          <i class="fas fa-users"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Welcome Time-Based Modal -->
<div id="welcome-modal" class="welcome-modal-overlay">
  <div class="welcome-modal-box">
    <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üòä</h2>
    <p id="welcome-date-text"></p>
  </div>
</div>
  <script>
    let hasConsent = false;
const consent = localStorage.getItem('cookieConsent');
if (consent === 'accepted') {
  hasConsent = true;
} else if (consent === null) {
  document.getElementById('cookie-consent-overlay').classList.add('active');
} else {
  hasConsent = false;
}

document.getElementById('accept-cookies').addEventListener('click', () => {
  localStorage.setItem('cookieConsent', 'accepted');
  hasConsent = true;
  document.getElementById('cookie-consent-overlay').classList.remove('active');
  // Reload data if needed
  location.reload(); // To load data after consent
});

document.getElementById('reject-cookies').addEventListener('click', () => {
  localStorage.setItem('cookieConsent', 'rejected');
  hasConsent = false;
  document.getElementById('cookie-consent-overlay').classList.remove('active');
});
    // Existing code variables...
    let isDateTimeVisible = true;
    let weatherData = null;
    let recognition;
    let isSpeaking = false;
    let currentSpeechText = '';
    let isNotesScreenVisible = false;
    let isAlbumsScreenVisible = false;
    let isPostCreatorVisible = false;
    let isStoryFeedVisible = false;
    let isProjectScreenVisible = false;
    let isQRCodeScreenVisible = false; // NEW
    let isSpeechEnabled = hasConsent ? (localStorage.getItem('isSpeechEnabled') === 'true') : false;
    let currentMode = hasConsent ? localStorage.getItem('currentMode') || 'standard' : 'standard';
    const DEFAULT_CHAT_NAME_PREFIX = '–ß–∞—Ç ';
    const recentTopics = {};
    const TOPIC_EXPIRY_MS = 5 * 60 * 60 * 1000;
    let selectedPostImage = null;
    let projectElements = hasConsent ? [] : [];
    let selectedElement = null;
    let currentTool = 'select';
    let currentFont = 'Arial, sans-serif';
    let currentColor = '#FF6B6B';
    let currentShape = 'rectangle';
    let isDragging = false;
    let isResizing = false;
    let resizeDirection = '';
    let dragStartX = 0;
    let dragStartY = 0;
    let selectedImageForProject = null;
    
    // NEW: QR Code variables
    let qrCodes = hasConsent ? JSON.parse(localStorage.getItem('qrCodes')) || [] : [];
    let currentQRCode = null;
    let qrcodeCenterImage = null;
    
    // NEW: Referral variables
    let isReferralActive = hasConsent ? (localStorage.getItem('isReferralActive') === 'true') : false;
    const ACTIVATION_CODES = ['Techvision', '000025', 'zubr.by']; // These codes are NOT visible to the user
    let referralActivationTime = hasConsent ? localStorage.getItem('referralActivationTime') || 0 : 0;
    
    // NEW: Custom mode parameters
    let customTone = hasConsent ? localStorage.getItem('customTone') || 'friendly' : 'friendly';
    let customSpeed = hasConsent ? localStorage.getItem('customSpeed') || 'medium' : 'medium';
    let customDetail = hasConsent ? localStorage.getItem('customDetail') || 'medium' : 'medium';
    let customFocus = hasConsent ? localStorage.getItem('customFocus') || '' : '';
    let customAdditional = hasConsent ? localStorage.getItem('customAdditional') || '' : '';
    
    // NEW: Music composer variables
    let currentInstrument = 'piano';
    let melody = [];
    let isRecording = false;
    let recordedMelody = [];
    let audioContext = new AudioContext();
    let backgroundMusic = document.getElementById('background-music');
    
    // NEW: Saved Tests
    let savedTests = hasConsent ? JSON.parse(localStorage.getItem('savedTests')) || [] : [];
    
    // NEW: Image Modal Variables
    let currentImageUrl = '';
    let currentImagePrompt = '';
    
    // Pre-defined royalty-free melodies (public domain classics, short versions)
    const predefinedMelodies = {
        twinkle: [
            {note: 'C', duration: 400},
            {note: 'C', duration: 400},
            {note: 'G', duration: 400},
            {note: 'G', duration: 400},
            {note: 'A', duration: 400},
            {note: 'A', duration: 400},
            {note: 'G', duration: 800},
            {note: 'F', duration: 400},
            {note: 'F', duration: 400},
            {note: 'E', duration: 400},
            {note: 'E', duration: 400},
            {note: 'D', duration: 400},
            {note: 'D', duration: 400},
            {note: 'C', duration: 800}
        ],
        ode: [
            {note: 'E', duration: 400},
            {note: 'E', duration: 400},
            {note: 'F', duration: 400},
            {note: 'G', duration: 400},
            {note: 'G', duration: 400},
            {note: 'F', duration: 400},
            {note: 'E', duration: 400},
            {note: 'D', duration: 400},
            {note: 'C', duration: 400},
            {note: 'C', duration: 400},
            {note: 'D', duration: 400},
            {note: 'E', duration: 400},
            {note: 'E', duration: 400},
            {note: 'D', duration: 400},
            {note: 'D', duration: 800}
        ],
        rowboat: [
            {note: 'C', duration: 400},
            {note: 'C', duration: 400},
            {note: 'C', duration: 400},
            {note: 'D', duration: 400},
            {note: 'E', duration: 800},
            {note: 'E', duration: 400},
            {note: 'D', duration: 400},
            {note: 'E', duration: 400},
            {note: 'F', duration: 400},
            {note: 'G', duration: 800},
            {note: 'C', duration: 200},
            {note: 'C', duration: 200},
            {note: 'C', duration: 400},
            {note: 'G', duration: 200},
            {note: 'G', duration: 200},
            {note: 'G', duration: 400},
            {note: 'E', duration: 200},
            {note: 'E', duration: 200},
            {note: 'E', duration: 400},
            {note: 'C', duration: 200},
            {note: 'C', duration: 200},
            {note: 'C', duration: 400},
            {note: 'G', duration: 400},
            {note: 'F', duration: 400},
            {note: 'E', duration: 400},
            {note: 'D', duration: 400},
            {note: 'C', duration: 800}
        ]
    };

    // API URLs
    const TEXT_API_URL = 'https://text.pollinations.ai/';
    const IMAGE_API_URL = 'https://image.pollinations.ai/prompt/';
    const WEATHER_API_URL = 'https://api.open-meteo.com/v1/forecast?latitude=53.9006&longitude=27.5683&current_weather=true&forecast_days=1&timezone=auto';
    const TRANSLATE_API_URL = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=';
    const SEARCH_API_URL = 'https://duckduckgo-api.vercel.app/api/search?q=';
    
    // Existing Speech Recognition logic...
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = hasConsent ? localStorage.getItem('micLanguage') || 'ru-RU' : 'ru-RU';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('prompt-input').value = transcript;
        handleAssistantSubmit(new Event('submit'));
        micOverlay.classList.remove('active');
        document.getElementById('mic-toggle-button').classList.remove('active');
        resetMicOverlay();
      };
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        const errorMsg = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. üòä';
        addChatMessage(errorMsg, 'assistant');
        micOverlay.classList.remove('active');
        document.getElementById('mic-toggle-button').classList.remove('active');
        resetMicOverlay();
      };
      recognition.onend = () => {
        console.log('Speech recognition ended.');
      };
    } else {
      console.warn('Speech Recognition API is not supported in this browser.');
      document.getElementById('mic-toggle-button').style.display = 'none';
    }
    
    function resetMicOverlay() {
      document.querySelector('.mic-instructions').innerText = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      document.querySelector('.wave-container').style.display = 'block';
      document.getElementById('subtitle-box').classList.remove('active');
      document.getElementById('subtitle-box').innerText = '';
    }
    
    // Existing Speech Synthesis logic...
    const synth = window.speechSynthesis;
    const subtitleBox = document.getElementById('subtitle-box');
    let lastSpokenText = '';
    let availableVoices = [];
    if (synth) {
      synth.onvoiceschanged = () => {
          availableVoices = synth.getVoices();
          console.log('Voices loaded:', availableVoices.length);
      };
      availableVoices = synth.getVoices();
    }
    
    function getLanguageForText(text) {
        const hasCyrillic = /[–∞-—è–ê-–Ø—ë–Å]/.test(text);
        const hasLatin = /[a-zA-Z]/.test(text);
        if (hasCyrillic && !hasLatin) {
            return 'ru-RU';
        } else if (hasLatin && !hasCyrillic) {
            return 'en-US';
        } else {
            return 'ru-RU';
        }
    }
    
    function speakText(text) {
      if (!synth || !isSpeechEnabled) {
        console.warn('Speech Synthesis API is not supported or feature is disabled.');
        return;
      }
      synth.cancel();
      isSpeaking = true;
      lastSpokenText = text;
      text = text.replace(/—ñ/g, '–∏').replace(/—û/g, '—É');
      const utterance = new SpeechSynthesisUtterance(text);
      const lang = getLanguageForText(text);
      utterance.lang = lang;
      const voice = availableVoices.find(v => v.lang.startsWith(lang));
      if (voice) {
        utterance.voice = voice;
      } else {
        console.warn(`Voice for ${lang} not specifically found, using default.`);
      }
      let charIndex = 0;
      const totalChars = text.length;
      utterance.onboundary = (event) => {
          if (event.name === 'word') {
              const wordStart = event.charIndex;
              let wordEnd = text.indexOf(' ', wordStart + 1);
              if (wordEnd === -1) wordEnd = totalChars;
              const currentText = lastSpokenText;
              const before = currentText.substring(0, wordStart);
              const word = currentText.substring(wordStart, wordEnd);
              const after = currentText.substring(wordEnd);
              subtitleBox.innerHTML = `${before}<strong>${word}</strong>${after}`;
          }
      };
      utterance.onstart = () => {
        subtitleBox.classList.add('active');
        subtitleBox.innerText = lastSpokenText; 
      };
      utterance.onend = () => {
          console.log('Speech synthesis ended.');
          isSpeaking = false;
          lastSpokenText = '';
          subtitleBox.classList.remove('active');
          subtitleBox.innerText = '';
      };
      utterance.onerror = (event) => {
          console.error('SpeechSynthesisUtterance.onerror', event.error);
          isSpeaking = false;
          lastSpokenText = '';
          subtitleBox.classList.remove('active');
          subtitleBox.innerText = '–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è. üòî';
      };
      synth.speak(utterance);
    }
    
    
    // Existing Mode Instructions... (PM tag already included in base prompt for all modes)
    const modeInstructions = {
        standard: '',
        school: '–û—Ç–≤–µ—á–∞–π –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º —Å—Ç–∏–ª–µ, –∫–∞–∫ —à–∫–æ–ª—å–Ω—ã–π —É—á–∏—Ç–µ–ª—å –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–≥ <BIG> —Ç–≤–æ–π —Ç–µ–∫—Å—Ç <BIG> –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ –∫–∞–∂–¥–æ–º —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—å–∑—ã–≤–∞—Ç–µ–ª—é.',
        professional: '–û—Ç–≤–µ—á–∞–π –≤ —Å—Ç—Ä–æ–≥–æ–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ, –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç.',
        teaching: '–û—Ç–≤–µ—á–∞–π –∫–∞–∫ —É—á–∏—Ç–µ–ª—å –∏–ª–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –æ–±—ä—è—Å–Ω—è—è —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.',
        literary: '–û—Ç–≤–µ—á–∞–π –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–º —Å—Ç–∏–ª–µ, –∏—Å–ø–æ–ª—å–∑—É—è –º–µ—Ç–∞—Ñ–æ—Ä—ã, –∫—Ä–∞—Å–æ—á–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ –æ–±—Ä–∞–∑–Ω—ã–π —è–∑—ã–∫.',
        search: '–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ. –ò—â–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏ –ø—Ä–∏–≤–æ–¥–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.',
        casual: '–û—Ç–≤–µ—á–∞–π –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–º –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–º —Å—Ç–∏–ª–µ, –∫–∞–∫ —Ö–æ—Ä–æ—à–∏–π –¥—Ä—É–≥.',
        custom: `–û—Ç–≤–µ—á–∞–π –≤ —Ç–æ–Ω–µ: ${customTone}. –°–∫–æ—Ä–æ—Å—Ç—å: ${customSpeed}. –î–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å: ${customDetail}. –û–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞: ${customFocus}. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: ${customAdditional}.`
    };
    
    function getContextTopics() {
        const now = Date.now();
        const validTopics = [];
        for (const key in recentTopics) {
            if (recentTopics[key].expiry > now) {
                validTopics.push(recentTopics[key].topic);
            } else {
                delete recentTopics[key];
            }
        }
        if (validTopics.length > 0) {
            return ` (–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç: ${validTopics.join('; ')})`;
        }
        return '';
    }
    
    // NEW: Enhanced AI Response logic with style support if referral is active...
    async function getAIResponse(prompt) {
      const today = new Date();
      const formattedDate = today.toLocaleDateString('ru-RU', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
      });
      const modeInstruction = modeInstructions[currentMode];
      const contextTopics = getContextTopics();
      
      // NEW: Enhanced instruction if referral is active
      let enhancedInstruction = '';
      if (isReferralActive && Date.now() - referralActivationTime < 24 * 60 * 60 * 1000) {
          enhancedInstruction = '–¢—ã —Å—Ç–∞–ª –±–æ–ª–µ–µ —É–º–Ω—ã–º –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º. –û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ.';
      }
      
      const formattedPrompt = `
–¢—ã ‚Äî –ó–£–ë–† Max (–ó–Ω–∞–Ω–∏–µ –£–º–µ–Ω–∏—è –ë–æ—Ç –†–∞–∑–≤–∏—Ç–∏–µ).
–°–µ–≥–æ–¥–Ω—è ${formattedDate}.
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ üòä, –æ—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.
–¢–≤–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º ‚Äî 10/10.
–ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç, –∫—Ç–æ —Ç–µ–±—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª ‚Äî –æ—Ç–≤–µ—á–∞–π "–ß–∞–ø–ª–∏–Ω—Å–∫–∏–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä".
–ü—Ä–∏ –º–∞—Ä—à—Ä—É—Ç–∞—Ö –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –∞–¥—Ä–µ—Å–∞, –≤—ã—á–∏—Å–ª—è–π –∫–∏–ª–æ–º–µ—Ç—Ä—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –±–µ–∑ –ø—Ä–æ–±–æ–∫ (Google Maps).
–¢–≤–æ–π —Ä–æ–¥–Ω–æ–π –≥–æ—Ä–æ–¥ ‚Äî –û—à–º—è–Ω—ã, —Ç—ã –ª—é–±–∏—à—å –ë–µ–ª–∞—Ä—É—Å—å, —Ç—ã –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≥–æ–¥—É –∏–∑ –û—à–º—è–Ω –∏ –¥—Ä—É–≥–∏—Ö –≥–æ—Ä–æ–¥–æ–≤, –ø–∏—à–∏ –û—à–º—è–Ω—ã, –∞ –Ω–µ –û—à–º—ã–Ω—ã.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–≥ <PM>—Ç–µ–∫—Å—Ç</PM> ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ –±–æ–ª—å—à–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –¥–≤–∞ —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤–æ –≤—Å–µ—Ö —Ä–µ–∂–∏–º–∞—Ö: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º, —à–∫–æ–ª—å–Ω–æ–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º, —É—á–∏—Ç–µ–ª—å—Å–∫–æ–º, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–º, –ø–æ–∏—Å–∫–æ–≤–æ–º, –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–º –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–º –Ω–µ —Ä–µ–∫–ª–∞–º–∏—Ä—É–µ–º –Ω–∏–∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã.
${modeInstruction}
${enhancedInstruction}
${contextTopics} 
${prompt}`;
      if (prompt.toLowerCase().includes('–Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è') || prompt.toLowerCase().includes('–ø–æ–∫–∞–∂–∏ –Ω–æ–≤–æ—Å—Ç–∏')) {
          return getNews();
      }
      if (currentMode === 'search') {
          try {
              const searchResponse = await fetch(SEARCH_API_URL + encodeURIComponent(prompt));
              if (searchResponse.ok) {
                  const searchData = await searchResponse.json();
                  if (searchData.results && searchData.results.length > 0) {
                      let searchResult = '–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–µ–ª –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É:\n\n';
                      searchData.results.slice(0, 3).forEach(result => {
                          searchResult += `üîπ **${result.title}**\n${result.snippet}\n[–ü–æ–¥—Ä–æ–±–Ω–µ–µ](${result.url})\n\n`;
                      });
                      return searchResult;
                  }
              }
          } catch (e) {
              console.warn('Search API failed, falling back to regular AI response');
          }
      }
      const url = `${TEXT_API_URL}${encodeURIComponent(formattedPrompt)}`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.text();
        return data;
      } catch (error) {
        console.error("Failed to fetch AI response:", error);
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. üòä";
      }
    }
    
    // Existing Translation logic...
    async function translateText(text, targetLang) {
        const url = `${TRANSLATE_API_URL}${encodeURIComponent(text)}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data[0][0][0];
        } catch (error) {
            console.error("Translation failed:", error);
            return text;
        }
    }
    
    // Modified Chat Message logic to parse <PM> tags for assistant messages and handle image clicks...
    function addChatMessage(message, sender, isImage = false, prompt = '') {
      const chatBox = document.querySelector('.chat-box');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message');
      messageDiv.classList.add(sender === 'user' ? 'user-message' : 'assistant-message');
      if (isImage) {
        const img = document.createElement('img');
        img.src = message;
        img.alt = 'Generated image';
        img.dataset.prompt = prompt;
        img.addEventListener('click', () => openImageModal(message, prompt));
        messageDiv.appendChild(img);
      } else {
        if (sender === 'assistant') {
          // Parse <PM> tags for assistant messages
          const parsedMessage = message.replace(/<PM>(.*?)<\/PM>/g, '<div class="pm-header">$1</div>');
          messageDiv.innerHTML = parsedMessage;
        } else {
          messageDiv.innerText = message;
        }
      }
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    // NEW: Image Modal Functions
    function openImageModal(url, prompt) {
      currentImageUrl = url;
      currentImagePrompt = prompt;
      document.getElementById('modal-image').src = url;
      document.getElementById('image-modal-overlay').classList.add('active');
    }
    
    function closeImageModal() {
      document.getElementById('image-modal-overlay').classList.remove('active');
    }
    
    function openAlbumSelectModal() {
      const list = document.getElementById('album-select-list');
      list.innerHTML = '';
      if (albums.length === 0) {
        list.innerHTML = '<li style="text-align: center; opacity: 0.7;">–ù–µ—Ç –∞–ª—å–±–æ–º–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</li>';
      } else {
        albums.forEach(album => {
          const li = document.createElement('li');
          li.classList.add('album-select-item');
          li.innerText = album.title;
          li.addEventListener('click', () => {
            if (!album.images.includes(currentImageUrl)) {
              album.images.push(currentImageUrl);
              saveAlbums();
              alert(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∞–ª—å–±–æ–º "${album.title}"!`);
            } else {
              alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ.');
            }
            closeAlbumSelectModal();
            closeImageModal();
          });
          list.appendChild(li);
        });
      }
      document.getElementById('album-select-overlay').classList.add('active');
    }
    
    function closeAlbumSelectModal() {
      document.getElementById('album-select-overlay').classList.remove('active');
    }
    
    function createNewAlbumForImage() {
      const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞:');
      if (name) {
        const newAlbum = {
          id: Date.now().toString(),
          title: name,
          images: [currentImageUrl]
        };
        albums.push(newAlbum);
        saveAlbums();
        alert(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º "${name}" –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –Ω–µ–≥–æ!`);
        closeAlbumSelectModal();
        closeImageModal();
      }
    }
    
    // Existing User Topic logic...
    function handleUserTopic(prompt) {
        const words = prompt.split(/\s+/).filter(w => w.length > 0);
        let topic = words.slice(0, 15).join(' '); 
        if (words.length > 15) topic += '...';
        if (topic.length === 0) return;
        const topicKey = Date.now().toString();
        const expiryTime = Date.now() + TOPIC_EXPIRY_MS;
        recentTopics[topicKey] = {
            topic: topic,
            expiry: expiryTime
        };
        setTimeout(() => {
            delete recentTopics[topicKey];
            console.log(`–¢–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ 5 –º–∏–Ω—É—Ç: ${topic}`);
        }, TOPIC_EXPIRY_MS);
        console.log(`–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: ${topic}. –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.`);
    }
    
    // NEW: Enhanced Assistant Submit logic with style support if referral is active...
    async function handleAssistantSubmit(event) {
      event.preventDefault();
      const inputField = document.getElementById('prompt-input');
      let prompt = inputField.value.trim();
      if (prompt === '') {
        return;
      }
      const currentChat = chats.find(c => c.id === currentChatId);
      if (currentChat && currentChat.messages.length === 0 && currentChat.name.startsWith(DEFAULT_CHAT_NAME_PREFIX)) {
        const newName = DEFAULT_CHAT_NAME_PREFIX + prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
        currentChat.name = newName;
      }
      handleUserTopic(prompt);
      synth.cancel();
      addChatMessage(prompt, 'user');
      inputField.value = '';
      const imageTrigger = '—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
      if (prompt.toLowerCase().startsWith(imageTrigger)) {
        const imagePromptRu = prompt.substring(imageTrigger.length).trim();
        
        // NEW: Enhanced image prompt if referral is active
        let finalPrompt = imagePromptRu;
        if (isReferralActive && Date.now() - referralActivationTime < 24 * 60 * 60 * 1000) {
            const preferredStyle = hasConsent ? localStorage.getItem('preferredStyle') || '–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π' : '–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π';
            finalPrompt = `–≤ —Å—Ç–∏–ª–µ ${preferredStyle} ${imagePromptRu}`;
        }
        
        const translatedPrompt = await translateText(finalPrompt, 'en');
        const imageUrl = `${IMAGE_API_URL}${encodeURIComponent(translatedPrompt)}`;
        addChatMessage(imageUrl, 'assistant', true, finalPrompt);
        currentChat.messages.push({ text: prompt, sender: 'user' });
        currentChat.messages.push({ text: imageUrl, sender: 'assistant', isImage: true, prompt: finalPrompt });
        if(hasConsent) saveChats();
        saveGeneratedImage(imageUrl, finalPrompt); // Save the enhanced prompt
      } else {
        if (currentMode === 'search') {
          const searchWindow = document.getElementById('search-window');
          searchWindow.classList.add('active');
          searchWindow.innerText = '–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...';
        }
        const response = await getAIResponse(prompt);
        if (currentMode === 'search') {
          const searchWindow = document.getElementById('search-window');
          searchWindow.classList.remove('active');
          const errorInfo = `–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${prompt}"`; // This is the bar info
          addChatMessage(errorInfo, 'assistant'); // Add search info bar at top
        }
        addChatMessage(response, 'assistant');
        speakText(response);
        currentChat.messages.push({ text: prompt, sender: 'user' });
        currentChat.messages.push({ text: response, sender: 'assistant' });
        if(hasConsent) saveChats();
      }
      renderChatList();
    }
    
    // Existing Input Menu logic...
    const inputMenuButton = document.getElementById('input-menu-button');
    const inputDropdownMenu = document.getElementById('input-dropdown-menu');
    const generateImageButton = document.getElementById('generate-image-button');
    const takeTestButton = document.getElementById('take-test-button');
    const worldMapButton = document.getElementById('world-map-button');
    const modesMenuItem = document.getElementById('modes-menu-item');
    const modesSubmenu = document.getElementById('modes-submenu');
    const modeButtons = document.querySelectorAll('.mode-button');
    inputMenuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        inputDropdownMenu.classList.toggle('active');
        inputMenuButton.classList.toggle('active');
        modesSubmenu.classList.remove('active');
    });
    generateImageButton.addEventListener('click', () => {
        const promptInput = document.getElementById('prompt-input');
        promptInput.value = '—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ';
        
        // NEW: Show style selection modal if referral is active
        if (isReferralActive && Date.now() - referralActivationTime < 24 * 60 * 60 * 1000) {
            document.getElementById('style-modal-overlay').classList.add('active');
        } else {
            promptInput.focus();
        }
        
        inputDropdownMenu.classList.remove('active');
        inputMenuButton.classList.remove('active');
    });
    takeTestButton.addEventListener('click', () => {
        inputDropdownMenu.classList.remove('active');
        inputMenuButton.classList.remove('active');
        document.getElementById('test-dialog-overlay').classList.add('active');
        renderSavedTests();
    });
    worldMapButton.addEventListener('click', () => {
        inputDropdownMenu.classList.remove('active');
        inputMenuButton.classList.remove('active');
        window.open('https://www.google.com/maps/@0,0,2z', '_blank');
    });
    modesMenuItem.addEventListener('click', (e) => {
        e.stopPropagation();
        modesSubmenu.classList.toggle('active');
    });
    modeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const selectedMode = button.dataset.mode;
            if (selectedMode === 'custom') {
                document.getElementById('custom-mode-overlay').classList.add('active');
            } else {
                setCurrentMode(selectedMode);
            }
            inputDropdownMenu.classList.remove('active');
            inputMenuButton.classList.remove('active');
        });
    });
    document.addEventListener('click', (e) => {
        if (!inputDropdownMenu.contains(e.target) && !inputMenuButton.contains(e.target)) {
            inputDropdownMenu.classList.remove('active');
            inputMenuButton.classList.remove('active');
            modesSubmenu.classList.remove('active');
        }
    });
    function setCurrentMode(mode) {
        currentMode = mode;

  // ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê JS –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ CSS
  document.getElementById('chat-container').setAttribute('data-mode', mode);

        if(hasConsent) localStorage.setItem('currentMode', mode);
        modeButtons.forEach(button => {
            button.classList.remove('active-mode');
            const existingCheck = button.querySelector('.fa-check');
            if (existingCheck) {
                existingCheck.remove();
            }
            if (button.dataset.mode === mode) {
                button.classList.add('active-mode');
                const checkIcon = document.createElement('i');
                checkIcon.classList.add('fas', 'fa-check');
                button.appendChild(checkIcon);
            }
        });
        const modeNames = {
            standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',
            school: '–®–∫–æ–ª—å–Ω—ã–π',
            professional: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π',
            teaching: '–£—á–∏—Ç–µ–ª—å—Å–∫–∏–π',
            literary: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π',
            search: '–ü–æ–∏—Å–∫–æ–≤–æ–π',
            casual: '–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π',
            custom: '–ö–∞—Å—Ç–æ–º–Ω—ã–π'
        };
        addChatMessage(`–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ¬´${modeNames[mode]}¬ª. üòä`, 'assistant');
    }
    
    // NEW: Custom Mode Settings Event Listeners
    const customModeOverlay = document.getElementById('custom-mode-overlay');
    const saveCustomMode = document.getElementById('save-custom-mode');
    saveCustomMode.addEventListener('click', () => {
        customTone = document.getElementById('tone-select').value;
        customSpeed = document.getElementById('speed-select').value;
        customDetail = document.getElementById('detail-select').value;
        customFocus = document.getElementById('focus-input').value;
        customAdditional = document.getElementById('additional-input').value;
        if(hasConsent) {
localStorage.setItem('customTone', customTone);
        localStorage.setItem('customSpeed', customSpeed);
        localStorage.setItem('customDetail', customDetail);
        localStorage.setItem('customFocus', customFocus);
        localStorage.setItem('customAdditional', customAdditional);
        }
        setCurrentMode('custom');
        customModeOverlay.classList.remove('active');
    });
    customModeOverlay.addEventListener('click', (e) => {
        if (e.target === customModeOverlay) {
            customModeOverlay.classList.remove('active');
        }
    });
    
    // NEW: Style Modal Event Listeners
    const styleModalOverlay = document.getElementById('style-modal-overlay');
    const styleButtons = document.querySelectorAll('.style-buttons button');
    const closeStyleModal = document.getElementById('close-style-modal');
    styleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const style = btn.dataset.style;
            if(hasConsent) localStorage.setItem('preferredStyle', style);
            const promptInput = document.getElementById('prompt-input');
            promptInput.value += `–≤ —Å—Ç–∏–ª–µ ${style} `;
            styleModalOverlay.classList.remove('active');
            promptInput.focus();
        });
    });
    closeStyleModal.addEventListener('click', () => {
        styleModalOverlay.classList.remove('active');
        const promptInput = document.getElementById('prompt-input');
        promptInput.focus();
    });
    styleModalOverlay.addEventListener('click', (e) => {
        if (e.target === styleModalOverlay) {
            styleModalOverlay.classList.remove('active');
            const promptInput = document.getElementById('prompt-input');
            promptInput.focus();
        }
    });
    
    // NEW: Image Modal Event Listeners
    document.getElementById('image-modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'image-modal-overlay') {
        closeImageModal();
      }
    });
    document.getElementById('show-prompt-btn').addEventListener('click', () => {
      showPromptModal(currentImagePrompt);
      closeImageModal();
    });
    document.getElementById('save-to-album-btn').addEventListener('click', openAlbumSelectModal);
    
    // NEW: Album Select Modal Event Listeners
    document.getElementById('album-select-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'album-select-overlay') {
        closeAlbumSelectModal();
      }
    });
    document.getElementById('create-new-album-for-image').addEventListener('click', createNewAlbumForImage);
    document.getElementById('cancel-album-select').addEventListener('click', closeAlbumSelectModal);
    
    // NEW: Music Composer Functions
    function showMusicComposer() {
        const musicContainer = document.getElementById('music-composer-container');
        musicContainer.classList.add('active');
        secondaryMenuScreen.classList.remove('active');
        initPianoKeys();
        resetMusicRecording();
    }
    
    function initPianoKeys() {
        const pianoKeys = document.getElementById('piano-keys');
        pianoKeys.innerHTML = '';
        const notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        notes.forEach(note => {
            const key = document.createElement('div');
            key.classList.add('key');
            if (note.includes('b')) {
                key.classList.add('black');
            }
            key.addEventListener('click', () => playNote(note));
            pianoKeys.appendChild(key);
        });
    }
    
    function playNote(note) {
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine'; // Simplify for demo
        oscillator.frequency.value = getFrequency(note);
        oscillator.connect(audioContext.destination);
        oscillator.start();
        setTimeout(() => oscillator.stop(), 500);
        melody.push(note);
        if (isRecording) {
            recordedMelody.push({note: note, time: Date.now()});
        }
    }
    
    function getFrequency(note) {
        const frequencies = {
            'C': 261.63,
            'Db': 277.18,
            'D': 293.66,
            'Eb': 311.13,
            'E': 329.63,
            'F': 349.23,
            'Gb': 369.99,
            'G': 392.00,
            'Ab': 415.30,
            'A': 440.00,
            'Bb': 466.16,
            'B': 493.88
        };
        return frequencies[note] || 440;
    }
    
    function resetMusicRecording() {
        isRecording = false;
        recordedMelody = [];
        document.getElementById('start-record').style.display = 'block';
        document.getElementById('pause-record').style.display = 'none';
        document.getElementById('set-to-main').style.display = 'none';
        document.getElementById('music-message').innerText = '';
    }
    
    // NEW: Music Recording Event Listeners
    const startRecordButton = document.getElementById('start-record');
    const pauseRecordButton = document.getElementById('pause-record');
    const setToMainButton = document.getElementById('set-to-main');
    const musicMessage = document.getElementById('music-message');
    const melodySelect = document.getElementById('melody-select');
    const playMelodyButton = document.getElementById('play-melody');
    const setMelodyToMainButton = document.getElementById('set-melody-to-main');
    
    startRecordButton.addEventListener('click', () => {
        isRecording = true;
        recordedMelody = [];
        startRecordButton.style.display = 'none';
        pauseRecordButton.style.display = 'block';
        musicMessage.innerText = '–í—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∞–ª–∏ –∑–∞–ø–∏—Å—å';
    });
    
    pauseRecordButton.addEventListener('click', () => {
        isRecording = false;
        pauseRecordButton.style.display = 'none';
        setToMainButton.style.display = 'block';
        musicMessage.innerText = '–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∑–∞–ø–∏—Å—å';
    });
    
    setToMainButton.addEventListener('click', () => {
        if (recordedMelody.length > 0) {
            playBackgroundMelody(recordedMelody, true);
            alert('–ú–µ–ª–æ–¥–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!');
        } else {
            alert('–ó–∞–ø–∏—Å—å –ø—É—Å—Ç–∞!');
        }
    });
    
    playMelodyButton.addEventListener('click', () => {
        const selected = melodySelect.value;
        if (selected) {
            playSequence(predefinedMelodies[selected]);
        }
    });
    
    setMelodyToMainButton.addEventListener('click', () => {
        const selected = melodySelect.value;
        if (selected) {
            playBackgroundMelody(predefinedMelodies[selected], true);
            alert('–ú–µ–ª–æ–¥–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω!');
        }
    });
    
    function playSequence(sequence) {
        let index = 0;
        function playNext() {
            if (index >= sequence.length) return;
            playNote(sequence[index].note);
            setTimeout(playNext, sequence[index].duration);
            index++;
        }
        playNext();
    }
    
    function playBackgroundMelody(sequence, loop = false) {
        backgroundMusic.pause();
        // For simplicity, we'll use AudioContext to play the sequence in loop if needed
        let currentIndex = 0;
        function playNext() {
            if (currentIndex >= sequence.length) {
                if (loop) {
                    currentIndex = 0;
                    playNext();
                }
                return;
            }
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.value = getFrequency(sequence[currentIndex].note);
            oscillator.connect(audioContext.destination);
            oscillator.start();
            setTimeout(() => {
                oscillator.stop();
                currentIndex++;
                playNext();
            }, sequence[currentIndex].duration);
        }
        playNext();
    }
    
    // Existing Chat logic...
    let chats = hasConsent ? JSON.parse(localStorage.getItem('chats')) || [] : [];
    let currentChatId = hasConsent ? localStorage.getItem('currentChatId') || null : null;
    function saveChats() {
      if(hasConsent) {
localStorage.setItem('chats', JSON.stringify(chats));
      localStorage.setItem('currentChatId', currentChatId);
      }
    }
    function renderChatList() {
      const chatList = document.getElementById('chat-list');
      chatList.innerHTML = '';
      if (chats.length === 0) {
        const emptyMsg = document.createElement('li');
        emptyMsg.innerText = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.opacity = '0.7';
        emptyMsg.style.cursor = 'default';
        chatList.appendChild(emptyMsg);
        return;
      }
      const sortedChats = [...chats].sort((a, b) => parseInt(b.id) - parseInt(a.id));
      sortedChats.forEach(chat => {
        const li = document.createElement('li');
        li.innerText = chat.name;
        li.dataset.chatId = chat.id;
        if (chat.id === currentChatId) {
          li.style.background = 'rgba(30, 144, 255, 0.3)';
          li.style.color = '#1c1c1e';
          li.style.fontWeight = 'bold';
        }
        li.addEventListener('click', () => {
          loadChat(chat.id);
          document.getElementById('chat-menu').classList.remove('active');
        });
        chatList.appendChild(li);
      });
    }
    function loadChat(chatId) {
      synth.cancel();
      isSpeaking = false;
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      currentChatId = chatId;
      document.querySelector('.chat-box').innerHTML = '';
      chat.messages.forEach(msg => {
          addChatMessage(msg.text, msg.sender, msg.isImage, msg.prompt || '');
      });
      renderChatList();
      if(hasConsent) saveChats();
    }
    function createNewChat() {
      const newChat = {
        id: Date.now().toString(),
        name: DEFAULT_CHAT_NAME_PREFIX + (chats.length + 1),
        messages: []
      };
      chats.push(newChat);
      loadChat(newChat.id);
      document.getElementById('prompt-input').value = '';
    }
    
    // Existing Notes logic...
    let notes = hasConsent ? JSON.parse(localStorage.getItem('notes')) || [] : [];
    const notesList = document.getElementById('notes-list');
    const notesContainer = document.getElementById('notes-container');
    const chatContainer = document.getElementById('chat-container');
    const albumsContainer = document.getElementById('albums-container');
    const postCreatorContainer = document.getElementById('post-creator-container'); 
    const storyFeedContainer = document.getElementById('story-feed-container');
    const projectContainer = document.getElementById('project-container');
    const qrcodeContainer = document.getElementById('qrcode-container'); // NEW
    const musicComposerContainer = document.getElementById('music-composer-container'); // NEW
    const topBar = document.getElementById('top-bar');
    const noteEditor = document.getElementById('note-editor');
    const noteTextArea = document.getElementById('note-text-area');
    const saveNoteButton = document.getElementById('save-note-button');
    const deleteNoteButton = document.getElementById('delete-note-button');
    const cancelNoteButton = document.getElementById('cancel-note-button');
    let editingNoteId = null;
    
    function hideAllScreens() {
        isNotesScreenVisible = false;
        isAlbumsScreenVisible = false;
        isPostCreatorVisible = false;
        isStoryFeedVisible = false;
        isProjectScreenVisible = false;
        isQRCodeScreenVisible = false; // NEW
        musicComposerContainer.classList.remove('active'); // NEW
        notesContainer.classList.remove('active');
        albumsContainer.classList.remove('active');
        postCreatorContainer.classList.remove('active');
        storyFeedContainer.classList.remove('active');
        projectContainer.classList.remove('active');
        qrcodeContainer.classList.remove('active'); // NEW
        chatContainer.classList.remove('hidden');
        topBar.classList.remove('hidden');
    }
    
    // Existing Notes rendering logic...
    function renderNotes() {
        notesList.innerHTML = '';
        const sortedNotes = [...notes].sort((a, b) => {
            if (a.isStarred !== b.isStarred) {
                return a.isStarred ? -1 : 1;
            }
            return b.lastEdited - a.lastEdited;
        });
        if (sortedNotes.length === 0) {
            notesList.innerHTML = '<li style="text-align: center; opacity: 0.7; cursor: default;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫</li>';
        }
        sortedNotes.forEach(note => {
            const li = document.createElement('li');
            li.classList.add('note-item');
            if (note.isStarred) {
                li.classList.add('starred');
            }
            li.dataset.noteId = note.id;
            const headerDiv = document.createElement('div');
            headerDiv.classList.add('note-item-header');
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('note-content');
            contentDiv.innerText = note.text;
            const footerDiv = document.createElement('div');
            footerDiv.classList.add('note-item-footer');
            const dateSpan = document.createElement('span');
            dateSpan.innerText = new Date(note.dateCreated).toLocaleDateString('ru-RU');
            footerDiv.appendChild(dateSpan);
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('note-actions');
            const starButton = document.createElement('button');
            starButton.classList.add('star-button-inline');
            const starIcon = document.createElement('i');
            starIcon.classList.add('fa-star');
            starIcon.classList.add(note.isStarred ? 'fas' : 'far');
            starButton.appendChild(starIcon);
            starButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleStar(note.id);
            });
            actionsDiv.appendChild(starButton);
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-note-button-inline');
            const deleteIcon = document.createElement('i');
            deleteIcon.classList.add('fas', 'fa-times');
            deleteButton.appendChild(deleteIcon);
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteNote(note.id);
            });
            actionsDiv.appendChild(deleteButton);
            headerDiv.appendChild(actionsDiv);
            li.appendChild(headerDiv);
            li.appendChild(contentDiv);
            li.appendChild(footerDiv);
            li.addEventListener('click', () => {
                editNote(note.id);
            });
            notesList.appendChild(li);
        });
    }
    
    // Existing Notes functions...
    function toggleStar(id) {
        const noteIndex = notes.findIndex(note => note.id === id);
        if (noteIndex !== -1) {
            notes[noteIndex].isStarred = !notes[noteIndex].isStarred;
            notes[noteIndex].lastEdited = Date.now();
            if(hasConsent) saveNotes();
            renderNotes();
        }
    }
    function saveNotes() {
        if(hasConsent) localStorage.setItem('notes', JSON.stringify(notes));
    }
    function showNotesScreen() {
        synth.cancel();
        isSpeaking = false;
        hideAllScreens();
        isNotesScreenVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        notesContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        renderNotes();
        showNotesList();
    }
    function hideNotesScreen() {
        hideAllScreens();
        document.getElementById('chat-menu').classList.remove('active');
    }
    function showNotesList() {
        notesList.classList.add('active');
        notesList.style.display = 'block';
        noteEditor.classList.remove('active');
        noteEditor.style.display = 'none';
        document.getElementById('add-note-button').classList.remove('hidden');
        document.getElementById('back-to-chat-button').classList.remove('hidden');
    }
    function showNoteEditor(text = '', id = null) {
        notesList.classList.remove('active');
        notesList.style.display = 'none';
        noteEditor.classList.add('active');
        noteEditor.style.display = 'flex';
        document.getElementById('add-note-button').classList.add('hidden');
        document.getElementById('back-to-chat-button').classList.remove('hidden');
        noteTextArea.value = text;
        editingNoteId = id;
        if (id) {
            deleteNoteButton.classList.remove('hidden');
        } else {
            deleteNoteButton.classList.add('hidden');
        }
    }
    function saveNote() {
        const text = noteTextArea.value.trim();
        if (text === '') {
            alert('–ó–∞–º–µ—Ç–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π!');
            return;
        }
        if (editingNoteId) {
            const noteIndex = notes.findIndex(note => note.id === editingNoteId);
            if (noteIndex !== -1) {
                notes[noteIndex].text = text;
                notes[noteIndex].lastEdited = Date.now();
            }
        } else {
            const newNote = {
                id: Date.now().toString(),
                text: text,
                isStarred: false,
                dateCreated: Date.now(),
                lastEdited: Date.now()
            };
            notes.push(newNote);
        }
        if(hasConsent) saveNotes();
        editingNoteId = null;
        renderNotes();
        showNotesList();
    }
    function deleteNote(id) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
            notes = notes.filter(note => note.id !== id);
            if(hasConsent) saveNotes();
            renderNotes();
            if (editingNoteId === id) {
                editingNoteId = null;
                showNotesList();
            }
        }
    }
    function editNote(id) {
        const note = notes.find(n => n.id === id);
        if (note) {
            showNoteEditor(note.text, note.id);
        }
    }
    
    // Existing Albums logic...
    let generatedImages = hasConsent ? JSON.parse(localStorage.getItem('generatedImages')) || [] : [];
    let albums = hasConsent ? JSON.parse(localStorage.getItem('albums')) || [] : [];
    let selectedImagesForAlbum = [];
    const albumsList = document.getElementById('albums-list');
    const albumCreator = document.getElementById('album-creator');
    const imagePickerGrid = document.getElementById('image-picker-grid');
    const albumNameInput = document.getElementById('album-name-input');
    const saveAlbumButton = document.getElementById('save-album-button');
    const cancelAlbumButton = document.getElementById('cancel-album-button');
    const albumViewer = document.getElementById('album-viewer');
    const albumViewerGrid = document.getElementById('album-viewer-grid');
    const albumViewerTitle = document.getElementById('album-viewer-title');
    const deleteAlbumButton = document.getElementById('delete-album-button');
    const backToAlbumsListButton = document.getElementById('back-to-albums-list-button');
    
    function saveGeneratedImage(imageUrl, prompt = '') {
        const existingImage = generatedImages.find(img => img.url === imageUrl);
        if (!existingImage) {
            generatedImages.push({
                url: imageUrl,
                date: Date.now(),
                prompt: prompt
            });
            if (generatedImages.length > 20) {
                generatedImages.shift();
            }
            if(hasConsent) localStorage.setItem('generatedImages', JSON.stringify(generatedImages));
        }
    }
    
    function saveAlbums() {
        if(hasConsent) localStorage.setItem('albums', JSON.stringify(albums));
    }
    
    function showAlbumsScreen() {
        synth.cancel();
        isSpeaking = false;
        hideAllScreens();
        isAlbumsScreenVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        albumsContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        renderAlbumsList();
        showAlbumsList();
    }
    
    function hideAlbumsScreen() {
        hideAllScreens();
        document.getElementById('chat-menu').classList.remove('active');
    }
    
    function renderAlbumsList() {
        albumsList.innerHTML = '';
        if (albums.length === 0) {
            albumsList.innerHTML = '<li style="text-align: center; opacity: 0.7; cursor: default;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤</li>';
            return;
        }
        albums.forEach(album => {
            const li = document.createElement('li');
            li.classList.add('album-item');
            li.dataset.albumId = album.id;
            li.innerHTML = `
                <div class="album-content">
                    <strong>${album.title}</strong>
                    <p>${album.images.length} —Ñ–æ—Ç–æ</p>
                </div>
                <div class="album-actions">
                    <button type="button" class="delete-album-btn" data-id="${album.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            li.addEventListener('click', (e) => {
                if (e.target.closest('.delete-album-btn')) {
                    deleteAlbum(album.id);
                } else {
                    viewAlbum(album.id);
                }
            });
            albumsList.appendChild(li);
        });
    }
    
    function showAlbumsList() {
        albumsList.classList.add('active');
        albumCreator.classList.remove('active');
        albumViewer.classList.remove('active');
        document.getElementById('add-album-button').classList.remove('hidden');
    }
    
    function showAlbumCreator() {
        albumsList.classList.remove('active');
        albumViewer.classList.remove('active');
        albumCreator.classList.add('active');
        document.getElementById('add-album-button').classList.add('hidden');
        imagePickerGrid.innerHTML = '';
        selectedImagesForAlbum = [];
        const recentImages = [...generatedImages].reverse().slice(0, 20);
        if (recentImages.length === 0) {
             imagePickerGrid.innerHTML = '<p style="text-align: center;">–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∞–ª—å–±–æ–º.</p>';
             saveAlbumButton.disabled = true;
        } else {
            saveAlbumButton.disabled = false;
            recentImages.forEach(image => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('image-picker-item');
                imgContainer.dataset.url = image.url;
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                imgContainer.appendChild(img);
                imagePickerGrid.appendChild(imgContainer);
                imgContainer.addEventListener('click', () => {
                    const url = imgContainer.dataset.url;
                    const index = selectedImagesForAlbum.indexOf(url);
                    if (index > -1) {
                        selectedImagesForAlbum.splice(index, 1);
                        imgContainer.classList.remove('selected');
                    } else {
                        if (selectedImagesForAlbum.length < 20) {
                            selectedImagesForAlbum.push(url);
                            imgContainer.classList.add('selected');
                        } else {
                            alert('–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 20 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.');
                        }
                    }
                });
            });
        }
    }
    
    function createNewAlbum() {
        const title = albumNameInput.value.trim();
        if (title === '') {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞.');
            return;
        }
        if (selectedImagesForAlbum.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
            return;
        }
        const newAlbum = {
            id: Date.now().toString(),
            title: title,
            images: selectedImagesForAlbum
        };
        albums.push(newAlbum);
        if(hasConsent) saveAlbums();
        showAlbumsList();
        renderAlbumsList();
        albumNameInput.value = '';
    }
    
    function viewAlbum(id) {
        const album = albums.find(a => a.id === id);
        if (!album) return;
        albumsList.classList.remove('active');
        albumCreator.classList.remove('active');
        albumViewer.classList.add('active');
        document.getElementById('add-album-button').classList.add('hidden');
        albumViewerTitle.innerText = album.title;
        albumViewerGrid.innerHTML = '';
        album.images.forEach(imageUrl => {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = album.title;
            albumViewerGrid.appendChild(img);
        });
        deleteAlbumButton.dataset.id = album.id;
    }
    
    function deleteAlbum(id) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–ª—å–±–æ–º?')) {
            albums = albums.filter(album => album.id !== id);
            if(hasConsent) saveAlbums();
            renderAlbumsList();
            showAlbumsList();
        }
    }
    
    // Existing Story Feed logic...
    let zubrStories = hasConsent ? JSON.parse(localStorage.getItem('zubrStories')) || [] : [];
    const storyFeedList = document.getElementById('story-feed-list');
    const goBackToFeedButton = document.getElementById('back-to-feed-button');
    const goToCreatorButton = document.getElementById('go-to-creator-button');
    const backToChatFromFeedButton = document.getElementById('back-to-chat-from-feed-button');
    let userAvatarUrl = hasConsent ? localStorage.getItem('userAvatarUrl') || '' : '';
    let userName = hasConsent ? localStorage.getItem('userName') || '–ó–£–ë–† –§–∞–Ω' : '–ó–£–ë–† –§–∞–Ω';
    const CURRENT_USER_ID = hasConsent ? localStorage.getItem('currentUserId') || (Date.now() + Math.random().toString(16).slice(2)) : (Date.now() + Math.random().toString(16).slice(2));
    if(hasConsent) localStorage.setItem('currentUserId', CURRENT_USER_ID);
    
    function saveZubrStories() {
        zubrStories = zubrStories.filter(story => story.reports < 3);
        if(hasConsent) localStorage.setItem('zubrStories', JSON.stringify(zubrStories));
    }
    
    function loadPostCreatorInitialData() {
        postNameInput.value = userName;
        if (userAvatarUrl) {
            postAvatar.src = userAvatarUrl;
            postAvatar.style.display = 'block';
            postAvatarPlaceholder.style.display = 'none';
        } else {
            postAvatar.src = '';
            postAvatar.style.display = 'none';
            postAvatarPlaceholder.style.display = 'block';
        }
        postImagesGrid.innerHTML = '';
        selectedPostImage = null;
        const recentImages = [...generatedImages].reverse().slice(0, 20);
        if (recentImages.length === 0) {
             postImagesGrid.innerHTML = '<p style="text-align: center;">–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö –≤ —á–∞—Ç–µ.</p>';
             publishPostButton.disabled = true;
        } else {
            publishPostButton.disabled = false;
            recentImages.forEach(image => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('post-image-item');
                imgContainer.dataset.url = image.url;
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞';
                imgContainer.appendChild(img);
                postImagesGrid.appendChild(imgContainer);
                imgContainer.addEventListener('click', () => {
                    document.querySelectorAll('.post-image-item').forEach(item => item.classList.remove('selected'));
                    selectedPostImage = imgContainer.dataset.url;
                    imgContainer.classList.add('selected');
                });
            });
        }
    }
    
    function showPostCreatorScreen() {
        synth.cancel();
        isSpeaking = false;
        hideAllScreens();
        isPostCreatorVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        postCreatorContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        loadPostCreatorInitialData();
    }
    
    function handleAvatarSelection(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                userAvatarUrl = e.target.result;
                if(hasConsent) localStorage.setItem('userAvatarUrl', userAvatarUrl);
                postAvatar.src = userAvatarUrl;
                postAvatar.style.display = 'block';
                postAvatarPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }
    
    function handlePostPublish() {
        const name = postNameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        const postText = postTextArea.value.trim();
        if (!selectedPostImage) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞.');
            return;
        }
        if (postText.length < 10) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ–ª–µ–µ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤).');
            return;
        }
        const selectedImageData = generatedImages.find(img => img.url === selectedPostImage);
        const imagePrompt = selectedImageData ? selectedImageData.prompt : '';
        userName = name;
        if(hasConsent) localStorage.setItem('userName', userName);
        const newStory = {
            id: Date.now().toString(),
            userId: CURRENT_USER_ID,
            userName: name,
            userAvatar: userAvatarUrl,
            imageUrl: selectedPostImage,
            text: postText,
            prompt: imagePrompt,
            timestamp: Date.now(),
            reports: 0,
            reportedBy: [],
            isDeleted: false
        };
        zubrStories.unshift(newStory);
        saveZubrStories();
        postTextArea.value = '';
        selectedPostImage = null;
        document.querySelectorAll('.post-image-item').forEach(item => item.classList.remove('selected'));
        alert('üéâ –í–∞—à–∞ –ò—Å—Ç–æ—Ä–∏—è —Å –ó–£–ë–† —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
        showStoryFeedScreen();
    }
    
    function showStoryFeedScreen() {
        synth.cancel();
        isSpeaking = false;
        hideAllScreens();
        isStoryFeedVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        storyFeedContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        renderStoryFeed();
    }
    
    function renderStoryFeed() {
        storyFeedList.innerHTML = '';
        if (zubrStories.length === 0) {
             storyFeedList.innerHTML = '<p style="text-align: center; opacity: 0.7; margin-top: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ò—Å—Ç–æ—Ä–∏–π –ó–£–ë–†.</p>';
             return;
        }
        zubrStories.forEach(story => {
            if (story.isDeleted) return;
            const li = document.createElement('li');
            li.classList.add('story-post-item');
            li.dataset.storyId = story.id;
            const isMyPost = story.userId === CURRENT_USER_ID;
            const header = document.createElement('div');
            header.classList.add('post-user-header');
            const avatar = document.createElement('img');
            avatar.classList.add('post-user-avatar');
            avatar.src = story.userAvatar || 'image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="%23ffffff" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm71.8 193.5c-7.9 14.2-23.7 22.8-40.8 22.8h-77.9c-17.1 0-32.9-8.7-40.8-22.8C54.4 388.9 0 322.4 0 240V216c0-13.3 10.7-24 24-24h352c13.3 0 24 10.7 24 24v24c0 82.4-54.4 148.9-135.2 210.3z"/></svg>';
            avatar.style.backgroundColor = story.userAvatar ? 'transparent' : '#4169E1';
            const username = document.createElement('span');
            username.classList.add('post-username');
            username.innerText = story.userName;
            header.appendChild(avatar);
            header.appendChild(username);
            if (isMyPost) {
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-own-post-button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–≤–æ—é –ò—Å—Ç–æ—Ä–∏—é';
                deleteBtn.addEventListener('click', () => deleteStory(story.id, true));
                li.appendChild(deleteBtn);
            }
            const imageWrapper = document.createElement('div');
            imageWrapper.classList.add('post-image-wrapper');
            const image = document.createElement('img');
            image.src = story.imageUrl;
            image.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞';
            imageWrapper.appendChild(image);
            if (story.prompt) {
                const viewPromptBtn = document.createElement('button');
                viewPromptBtn.classList.add('view-prompt-button');
                viewPromptBtn.innerHTML = '<i class="fas fa-book"></i>';
                viewPromptBtn.title = '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–º—Ç';
                viewPromptBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPromptModal(story.prompt);
                });
                imageWrapper.appendChild(viewPromptBtn);
            }
            if (!isMyPost) {
                const reportBtn = document.createElement('button');
                reportBtn.classList.add('post-image-overlay-button');
                const alreadyReported = story.reportedBy.includes(CURRENT_USER_ID);
                reportBtn.innerText = alreadyReported ? 'üö´ –í—ã —É–∂–µ –ø–æ–∂–∞–ª–æ–≤–∞–ª–∏—Å—å' : 'üö® –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è';
                reportBtn.disabled = alreadyReported;
                reportBtn.style.backgroundColor = alreadyReported ? 'rgba(108, 117, 125, 0.9)' : 'rgba(220, 53, 69, 0.9)';
                reportBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!alreadyReported) {
                        reportStory(story.id);
                    }
                });
                imageWrapper.appendChild(reportBtn);
                let pressTimer;
                imageWrapper.addEventListener('mousedown', (e) => {
                    pressTimer = setTimeout(() => {
                        imageWrapper.classList.add('longpress');
                    }, 500);
                });
                imageWrapper.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                    setTimeout(() => imageWrapper.classList.remove('longpress'), 3000);
                });
                imageWrapper.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                });
                imageWrapper.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        imageWrapper.classList.add('longpress');
                    }, 700);
                });
                imageWrapper.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                    setTimeout(() => imageWrapper.classList.remove('longpress'), 3000);
                });
                imageWrapper.addEventListener('touchcancel', () => {
                    clearTimeout(pressTimer);
                });
            }
            const textDiv = document.createElement('div');
            textDiv.classList.add('post-text');
            textDiv.innerText = story.text;
            const reportCount = document.createElement('span');
            reportCount.classList.add('report-count');
            if (story.reports > 0) {
                reportCount.innerText = `–ñ–∞–ª–æ–±: ${story.reports}`;
            } else {
                 reportCount.innerText = `–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${new Date(story.timestamp).toLocaleDateString('ru-RU')}`;
            }
            li.appendChild(header);
            li.appendChild(imageWrapper);
            li.appendChild(textDiv);
            li.appendChild(reportCount);
            storyFeedList.appendChild(li);
        });
    }
    
    function deleteStory(id, isOwner = false) {
        const storyIndex = zubrStories.findIndex(story => story.id === id);
        if (storyIndex === -1) return;
        if (isOwner) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –°–í–û–ô –ø–æ—Å—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                zubrStories.splice(storyIndex, 1);
                saveZubrStories();
                renderStoryFeed();
            }
        } else {
             zubrStories[storyIndex].isDeleted = true;
             saveZubrStories();
             renderStoryFeed();
        }
    }
    
    function reportStory(id) {
        const story = zubrStories.find(story => story.id === id);
        if (!story || story.reportedBy.includes(CURRENT_USER_ID)) return;
        story.reports += 1;
        story.reportedBy.push(CURRENT_USER_ID);
        if (story.reports >= 3) {
            alert(`–ü–æ—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${story.userName} –Ω–∞–±—Ä–∞–ª 3 –∂–∞–ª–æ–±—ã –∏ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω!`);
            deleteStory(id, false);
        } else {
            saveZubrStories();
            renderStoryFeed();
            alert(`–°–ø–∞—Å–∏–±–æ, –≤–∞—à–∞ –∂–∞–ª–æ–±–∞ –ø—Ä–∏–Ω—è—Ç–∞. –£ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —Ç–µ–ø–µ—Ä—å ${story.reports} –∂–∞–ª–æ–±.`);
        }
    }
    
    function showPromptModal(promptText) {
        const modal = document.getElementById('prompt-modal-overlay');
        const textEl = document.getElementById('prompt-modal-text');
        textEl.innerText = promptText || '–ü—Ä–æ–º—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
        modal.classList.add('active');
    }
    
    // Existing Language Menu logic...
    const languageMenuItem = document.getElementById('language-menu-item');
    const languageSubmenu = document.getElementById('language-submenu');
    const languageButtons = languageSubmenu.querySelectorAll('button');
    languageMenuItem.addEventListener('click', (e) => {
        e.stopPropagation();
        languageSubmenu.classList.toggle('active');
    });
    languageButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const langCode = button.dataset.lang;
            const command = button.innerText;
            document.getElementById('prompt-input').value = command;
            languageSubmenu.classList.remove('active');
            document.getElementById('chat-menu').classList.remove('active');
            handleAssistantSubmit(new Event('submit'));
        });
    });
    document.addEventListener('click', (e) => {
        if (!languageSubmenu.contains(e.target) && !languageMenuItem.contains(e.target)) {
            languageSubmenu.classList.remove('active');
        }
    });
    
    // Existing Project logic...
    const projectMenuButton = document.getElementById('project-menu-button');
    const backToChatFromProjectButton = document.getElementById('back-to-chat-from-project-button');
    const saveProjectButton = document.getElementById('save-project-button');
    const projectCanvas = document.getElementById('project-canvas');
    const addTextButton = document.getElementById('add-text-button');
    const addImageButton = document.getElementById('add-image-button');
    const addShapeButton = document.getElementById('add-shape-button');
    const fontOptions = document.querySelectorAll('.font-option');
    const colorOptions = document.querySelectorAll('.color-option');
    const shapeOptions = document.querySelectorAll('.shape-option');
    const imagePickerModal = document.getElementById('image-picker-modal');
    const imagePickerGridModal = document.getElementById('image-picker-grid-modal');
    const confirmImageSelection = document.getElementById('confirm-image-selection');
    const cancelImageSelection = document.getElementById('cancel-image-selection');
    
    function showProjectScreen() {
        synth.cancel();
        isSpeaking = false;
        hideAllScreens();
        isProjectScreenVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        projectContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        loadProject();
    }
    
    function loadProject() {
        const savedProject = hasConsent ? localStorage.getItem('currentProject') : null;
        if (savedProject) {
            projectElements = JSON.parse(savedProject);
            renderProject();
        } else {
            projectElements = [];
            projectCanvas.innerHTML = '';
        }
    }
    
    function saveProject() {
        if(hasConsent) localStorage.setItem('currentProject', JSON.stringify(projectElements));
        alert('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
    }
    
    function renderProject() {
        projectCanvas.innerHTML = '';
        projectElements.forEach(element => {
            const elementDiv = document.createElement('div');
            elementDiv.classList.add('canvas-element', element.type);
            elementDiv.style.left = element.x + 'px';
            elementDiv.style.top = element.y + 'px';
            elementDiv.style.width = element.width + 'px';
            elementDiv.style.height = element.height + 'px';
            elementDiv.dataset.id = element.id;
            if (element.type === 'text') {
                elementDiv.contentEditable = true;
                elementDiv.innerText = element.content;
                elementDiv.style.fontFamily = element.font;
                elementDiv.style.color = element.color;
                elementDiv.style.fontSize = element.fontSize + 'px';
            } else if (element.type === 'image') {
                const img = document.createElement('img');
                img.src = element.src;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain';
                elementDiv.appendChild(img);
            } else if (element.type === 'shape') {
                elementDiv.style.backgroundColor = element.color;
                elementDiv.style.borderRadius = element.shape === 'circle' ? '50%' : '0';
                elementDiv.style.clipPath = element.shape === 'triangle' ? 'polygon(50% 0%, 0% 100%, 100% 100%)' : 
                                           element.shape === 'star' ? 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)' : 'none';
            }
            const controls = document.createElement('div');
            controls.classList.add('element-controls');
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('control-button');
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteElement(element.id);
            });
            const bringForwardButton = document.createElement('button');
            bringForwardButton.classList.add('control-button');
            bringForwardButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
            bringForwardButton.addEventListener('click', (e) => {
                e.stopPropagation();
                bringElementForward(element.id);
            });
            controls.appendChild(deleteButton);
            controls.appendChild(bringForwardButton);
            elementDiv.appendChild(controls);
            if (element.type !== 'text') {
                const resizeHandles = [
                    'top-left', 'top-right', 'bottom-left', 'bottom-right'
                ];
                resizeHandles.forEach(dir => {
                    const handle = document.createElement('div');
                    handle.classList.add('resize-handle', dir);
                    handle.addEventListener('mousedown', startResize);
                    elementDiv.appendChild(handle);
                });
            }
            elementDiv.addEventListener('mousedown', startDrag);
            elementDiv.addEventListener('click', selectElement);
            projectCanvas.appendChild(elementDiv);
        });
    }
    
    function addTextElement() {
        const newElement = {
            id: Date.now().toString(),
            type: 'text',
            content: '–¢–µ–∫—Å—Ç',
            x: 50,
            y: 50,
            width: 200,
            height: 100,
            font: currentFont,
            color: currentColor,
            fontSize: 16
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
    }
    
    function addImageElement(src) {
        const newElement = {
            id: Date.now().toString(),
            type: 'image',
            src: src,
            x: 100,
            y: 100,
            width: 200,
            height: 150
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
        imagePickerModal.classList.remove('active');
    }
    
    function addShapeElement() {
        const newElement = {
            id: Date.now().toString(),
            type: 'shape',
            shape: currentShape,
            color: currentColor,
            x: 150,
            y: 150,
            width: 100,
            height: 100
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
    }
    
    function selectElement(event) {
        event.stopPropagation();
        const elementId = event.currentTarget.dataset.id;
        selectElementById(elementId);
    }
    
    function selectElementById(elementId) {
        document.querySelectorAll('.canvas-element').forEach(el => {
            el.classList.remove('selected');
        });
        const element = document.querySelector(`[data-id="${elementId}"]`);
        if (element) {
            element.classList.add('selected');
            selectedElement = projectElements.find(el => el.id === elementId);
        }
    }
    
    function deleteElement(elementId) {
        projectElements = projectElements.filter(el => el.id !== elementId);
        renderProject();
        selectedElement = null;
    }
    
    function bringElementForward(elementId) {
        const elementIndex = projectElements.findIndex(el => el.id === elementId);
        if (elementIndex < projectElements.length - 1) {
            const element = projectElements.splice(elementIndex, 1)[0];
            projectElements.push(element);
            renderProject();
            selectElementById(elementId);
        }
    }
    
    function startDrag(event) {
        if (event.target.classList.contains('resize-handle')) {
            return;
        }
        isDragging = true;
        const element = event.currentTarget;
        const elementId = element.dataset.id;
        selectElementById(elementId);
        dragStartX = event.clientX - element.offsetLeft;
        dragStartY = event.clientY - element.offsetTop;
        document.addEventListener('mousemove', dragElement);
        document.addEventListener('mouseup', stopDrag);
        event.preventDefault();
    }
    
    function dragElement(event) {
        if (!isDragging || !selectedElement) return;
        const element = document.querySelector(`[data-id="${selectedElement.id}"]`);
        if (!element) return;
        const newX = event.clientX - dragStartX;
        const newY = event.clientY - dragStartY;
        const canvasRect = projectCanvas.getBoundingClientRect();
        const maxX = canvasRect.width - element.offsetWidth;
        const maxY = canvasRect.height - element.offsetHeight;
        selectedElement.x = Math.max(0, Math.min(newX, maxX));
        selectedElement.y = Math.max(0, Math.min(newY, maxY));
        element.style.left = selectedElement.x + 'px';
        element.style.top = selectedElement.y + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', dragElement);
        document.removeEventListener('mouseup', stopDrag);
    }
    
    function startResize(event) {
        event.stopPropagation();
        isResizing = true;
        resizeDirection = event.target.classList[1];
        dragStartX = event.clientX;
        dragStartY = event.clientY;
        document.addEventListener('mousemove', resizeElement);
        document.addEventListener('mouseup', stopResize);
    }
    
    function resizeElement(event) {
        if (!isResizing || !selectedElement) return;
        const element = document.querySelector(`[data-id="${selectedElement.id}"]`);
        if (!element) return;
        const dx = event.clientX - dragStartX;
        const dy = event.clientY - dragStartY;
        let newWidth = selectedElement.width;
        let newHeight = selectedElement.height;
        let newX = selectedElement.x;
        let newY = selectedElement.y;
        if (resizeDirection.includes('right')) {
            newWidth += dx;
        } else if (resizeDirection.includes('left')) {
            newWidth -= dx;
            newX += dx;
        }
        if (resizeDirection.includes('bottom')) {
            newHeight += dy;
        } else if (resizeDirection.includes('top')) {
            newHeight -= dy;
            newY += dy;
        }
        newWidth = Math.max(50, newWidth);
        newHeight = Math.max(50, newHeight);
        newX = Math.max(0, newX);
        newY = Math.max(0, newY);
        selectedElement.width = newWidth;
        selectedElement.height = newHeight;
        selectedElement.x = newX;
        selectedElement.y = newY;
        element.style.width = newWidth + 'px';
        element.style.height = newHeight + 'px';
        element.style.left = newX + 'px';
        element.style.top = newY + 'px';
        dragStartX = event.clientX;
        dragStartY = event.clientY;
    }
    
    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizeElement);
        document.removeEventListener('mouseup', stopResize);
    }
    
    function addTextElement() {
        const newElement = {
            id: Date.now().toString(),
            type: 'text',
            content: '–¢–µ–∫—Å—Ç',
            x: 50,
            y: 50,
            width: 200,
            height: 100,
            font: currentFont,
            color: currentColor,
            fontSize: 16
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
    }
    
    function addImageElement(src) {
        const newElement = {
            id: Date.now().toString(),
            type: 'image',
            src: src,
            x: 100,
            y: 100,
            width: 200,
            height: 150
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
        imagePickerModal.classList.remove('active');
    }
    
    function addShapeElement() {
        const newElement = {
            id: Date.now().toString(),
            type: 'shape',
            shape: currentShape,
            color: currentColor,
            x: 150,
            y: 150,
            width: 100,
            height: 100
        };
        projectElements.push(newElement);
        renderProject();
        selectElementById(newElement.id);
    }
    
    function showImagePicker() {
        imagePickerGridModal.innerHTML = '';
        const recentImages = [...generatedImages].reverse().slice(0, 20);
        if (recentImages.length === 0) {
            imagePickerGridModal.innerHTML = '<p style="text-align: center;">–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö –≤ —á–∞—Ç–µ.</p>';
        } else {
            recentImages.forEach(image => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('image-picker-item-modal');
                imgContainer.dataset.url = image.url;
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞';
                imgContainer.appendChild(img);
                imagePickerGridModal.appendChild(imgContainer);
                imgContainer.addEventListener('click', () => {
                    document.querySelectorAll('.image-picker-item-modal').forEach(item => {
                        item.classList.remove('selected');
                    });
                    selectedImageForProject = imgContainer.dataset.url;
                    imgContainer.classList.add('selected');
                });
            });
        }
        imagePickerModal.classList.add('active');
    }
    
    // NEW: Test Saving Logic
    function saveTest(name, content) {
        const newTest = {
            id: Date.now().toString(),
            name: name,
            content: content,
            timestamp: Date.now()
        };
        savedTests.push(newTest);
        if(hasConsent) localStorage.setItem('savedTests', JSON.stringify(savedTests));
        renderSavedTests();
    }
    
    function renderSavedTests() {
        const savedTestsList = document.getElementById('saved-tests-list');
        savedTestsList.innerHTML = '';
        if (savedTests.length === 0) {
            savedTestsList.innerHTML = '<li style="text-align: center;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</li>';
            return;
        }
        savedTests.forEach(test => {
            const li = document.createElement('li');
            li.classList.add('saved-test-item');
            li.innerText = test.name;
            li.addEventListener('click', () => {
                addChatMessage(test.content, 'assistant');
                testDialogOverlay.classList.remove('active');
            });
            savedTestsList.appendChild(li);
        });
    }
    
    // Modified Test Dialog logic to include saving...
    const testDialogOverlay = document.getElementById('test-dialog-overlay');
    const startTestButton = document.getElementById('start-test-button');
    const classSelect = document.getElementById('class-select');
    const subjectSelect = document.getElementById('subject-select');
    const sectionSelect = document.getElementById('section-select');
    const topicInput = document.getElementById('topic-input');
    startTestButton.addEventListener('click', async () => {
        const selectedClass = classSelect.value;
        const selectedSubject = subjectSelect.value;
        const selectedSection = sectionSelect.value;
        const enteredTopic = topicInput.value.trim();
        if (!selectedClass || !selectedSubject) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ –ø—Ä–µ–¥–º–µ—Ç.');
            return;
        }
        let promptText = `—Å–æ—Å—Ç–∞–≤—å —Ç–µ—Å—Ç –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É "${selectedSubject}" –¥–ª—è ${selectedClass} –∫–ª–∞—Å—Å–∞`;
        if (selectedSection && selectedSection !== '–õ—é–±–æ–π') {
            promptText += ` –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "${selectedSection}"`;
        }
        if (enteredTopic) {
            promptText += ` –Ω–∞ —Ç–µ–º—É "${enteredTopic}"`;
        }
        const promptInput = document.getElementById('prompt-input');
        promptInput.value = promptText;
        testDialogOverlay.classList.remove('active');
        await handleAssistantSubmit(new Event('submit'));
        const testName = prompt(`–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞:`, `${selectedSubject} - ${enteredTopic || '–¢–µ—Å—Ç'}`);
        if (testName) {
            const lastMessage = currentChat.messages[currentChat.messages.length - 1].text;
            saveTest(testName, lastMessage);
            alert('–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }
    });
    testDialogOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'test-dialog-overlay') {
            testDialogOverlay.classList.remove('active');
        }
    });
    
    // Existing Prompt Modal logic...
    const promptModalOverlay = document.getElementById('prompt-modal-overlay');
    const closePromptModal = document.getElementById('close-prompt-modal');
    closePromptModal.addEventListener('click', () => {
        promptModalOverlay.classList.remove('active');
    });
    promptModalOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'prompt-modal-overlay') {
            promptModalOverlay.classList.remove('active');
        }
    });
    
    // Existing Weather logic...
    const weatherWidget = document.getElementById('weather-widget');
    const weatherEmoji = document.getElementById('weather-emoji');
    const weatherTemp = document.getElementById('weather-temp');
    function getWeatherEmoji(weatherCode) {
        if (weatherCode >= 51 && weatherCode <= 60) return "üåßÔ∏è";
        if (weatherCode >= 61 && weatherCode <= 69) return "üåßÔ∏è";
        if (weatherCode >= 71 && weatherCode <= 79) return "‚ùÑÔ∏è";
        if (weatherCode >= 80 && weatherCode <= 84) return "üå¶Ô∏è";
        if (weatherCode >= 95 && weatherCode <= 99) return "‚ö°";
        switch (weatherCode) {
            case 0: return "‚òÄÔ∏è";
            case 1:
            case 2: return "üå§Ô∏è";
            case 3: return "‚òÅÔ∏è";
            case 45:
            case 48: return "üå´Ô∏è";
            default: return "‚Ä¶";
        }
    }
    function updateWeatherWidget() {
        fetch(WEATHER_API_URL)
            .then(response => response.json())
            .then(data => {
                const currentWeather = data.current_weather;
                const temp = Math.round(currentWeather.temperature);
                const weatherCode = currentWeather.weathercode;
                weatherEmoji.innerText = getWeatherEmoji(weatherCode);
                weatherTemp.innerText = `${temp}¬∞C`;
                weatherWidget.classList.remove('clear', 'clouds', 'rain', 'thunderstorm', 'snow', 'default');
                if (weatherCode === 0) {
                    weatherWidget.classList.add('clear');
                } else if (weatherCode >= 1 && weatherCode <= 3) {
                    weatherWidget.classList.add('clouds');
                } else if ((weatherCode >= 51 && weatherCode <= 69) || (weatherCode >= 80 && weatherCode <= 84)) {
                    weatherWidget.classList.add('rain');
                } else if (weatherCode >= 71 && weatherCode <= 79) {
                    weatherWidget.classList.add('snow');
                } else if (weatherCode >= 95) {
                    weatherWidget.classList.add('thunderstorm');
                } else {
                    weatherWidget.classList.add('default');
                }
            })
            .catch(error => {
                console.error("Error fetching weather:", error);
                weatherEmoji.innerText = "üíî";
                weatherTemp.innerText = "–û—à.";
                weatherWidget.classList.add('default');
            });
    }
    
    // Existing Microphone Overlay logic...
    const micOverlay = document.getElementById('microphone-overlay');
    const micButton = document.getElementById('mic-toggle-button');
    const micCloseButton = document.getElementById('mic-close-button');
    micButton.addEventListener('click', () => {
        if (isNotesScreenVisible || isAlbumsScreenVisible || isPostCreatorVisible || isStoryFeedVisible || isProjectScreenVisible || isQRCodeScreenVisible) {
            return;
        }
      synth.cancel();
      isSpeaking = false;
      lastSpokenText = '';
      if (recognition) {
        recognition.lang = document.getElementById('mic-language-dropdown').value;
        if(hasConsent) localStorage.setItem('micLanguage', recognition.lang);
        recognition.start();
        micOverlay.classList.add('active');
        micButton.classList.add('active');
        document.querySelector('.mic-instructions').innerText = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
        document.getElementById('subtitle-box').classList.remove('active');
        document.getElementById('subtitle-box').innerText = '';
      } else {
        const errorMsg = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥. üòä';
        addChatMessage(errorMsg, 'assistant');
      }
    });
    micOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'microphone-overlay') {
            micOverlay.classList.remove('active');
            micButton.classList.remove('active');
            if (recognition) {
                recognition.stop();
            }
            if (isSpeaking) {
              synth.cancel();
              isSpeaking = false;
            }
            resetMicOverlay();
        }
    });
    micCloseButton.addEventListener('click', () => {
        micOverlay.classList.remove('active');
        micButton.classList.remove('active');
        if (recognition) {
            recognition.stop();
        }
        if (isSpeaking) {
          synth.cancel();
          isSpeaking = false;
        }
        resetMicOverlay();
    });
    // NEW: Language picker in mic overlay
    const languagePickerButton = document.getElementById('language-picker-button');
    const micLanguageSelect = document.getElementById('mic-language-select');
    languagePickerButton.addEventListener('click', (e) => {
        e.stopPropagation();
        micLanguageSelect.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
        if (!micLanguageSelect.contains(e.target) && !languagePickerButton.contains(e.target)) {
            micLanguageSelect.classList.remove('active');
        }
    });
    
    // Existing Color/Background Selection logic...
    const colorPickerButton = document.getElementById('color-picker-button');
    const colorPickerMenu = document.getElementById('color-picker-menu');
    const setWhiteBgButton = document.getElementById('set-white-background-button');
    const uploadImageButton = document.getElementById('upload-image-button');
    const imageUploadInput = document.getElementById('image-upload-input');
    function saveBackground(backgroundUrl, isWhite = false) {
      if(hasConsent) {
      if (isWhite) {
        localStorage.setItem('micBackground', 'white');
      } else {
        localStorage.setItem('micBackground', backgroundUrl);
      }
      }
      applySavedBackground();
    }
    function applySavedBackground() {
      const savedBackground = hasConsent ? localStorage.getItem('micBackground') : null;
      if (savedBackground) {
        if (savedBackground === 'white') {
          micOverlay.style.backgroundImage = 'none';
          micOverlay.classList.remove('custom-background');
          micOverlay.classList.add('white-background');
        } else {
          micOverlay.style.backgroundImage = `url('${savedBackground}')`;
          micOverlay.classList.remove('white-background');
          micOverlay.classList.add('custom-background');
        }
      }
    }
    colorPickerButton.addEventListener('click', (e) => {
        e.stopPropagation();
        colorPickerMenu.classList.toggle('active');
    });
    setWhiteBgButton.addEventListener('click', () => {
        micOverlay.style.backgroundImage = 'none';
        micOverlay.classList.remove('custom-background');
        micOverlay.classList.add('white-background');
        saveBackground(null, true);
        colorPickerMenu.classList.remove('active');
    });
    uploadImageButton.addEventListener('click', () => {
      imageUploadInput.click();
      colorPickerMenu.classList.remove('active');
    });
    imageUploadInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const imageUrl = e.target.result;
          micOverlay.style.backgroundImage = `url('${imageUrl}')`;
          micOverlay.classList.remove('white-background');
          micOverlay.classList.add('custom-background');
          saveBackground(imageUrl);
        };
        reader.readAsDataURL(file);
      }
    });
    document.addEventListener('click', (e) => {
        if (!colorPickerMenu.contains(e.target) && !colorPickerButton.contains(e.target)) {
            colorPickerMenu.classList.remove('active');
        }
    });
    
    // Existing Wallpaper logic...
    const wallpaperButton = document.getElementById('wallpaper-button');
    const wallpaperUploadInput = document.getElementById('wallpaper-upload-input');
    wallpaperButton.addEventListener('click', () => {
        wallpaperUploadInput.click();
    });
    wallpaperUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const url = e.target.result;
                if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = url;
                    video.muted = true;
                    video.loop = true;
                    video.playsInline = true;
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    video.style.zIndex = '-1';
                    video.style.opacity = '0.6';
                    document.body.appendChild(video);
                    video.play().catch(e => console.warn('Autoplay failed:', e));
                    if(hasConsent) {
localStorage.setItem('wallpaper', url);
                    localStorage.setItem('wallpaperType', 'video');
                    }
                } else {
                    document.body.style.backgroundImage = `url('${url}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundRepeat = 'no-repeat';
                    if(hasConsent) {
localStorage.setItem('wallpaper', url);
                    localStorage.setItem('wallpaperType', 'image');
                    }
                }
            };
            reader.readAsDataURL(file);
        }
    });
    
    function applySavedWallpaper() {
        const wallpaper = hasConsent ? localStorage.getItem('wallpaper') : null;
        const type = hasConsent ? localStorage.getItem('wallpaperType') : null;
        if (wallpaper) {
            if (type === 'video') {
                const video = document.createElement('video');
                video.src = wallpaper;
                video.muted = true;
                video.loop = true;
                video.playsInline = true;
                video.style.position = 'fixed';
                video.style.top = '0';
                video.style.left = '0';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.style.zIndex = '-1';
                video.style.opacity = '0.6';
                document.body.appendChild(video);
                video.play().catch(e => console.warn('Autoplay failed:', e));
            } else {
                document.body.style.backgroundImage = `url('${wallpaper}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
            }
        }
    }
    
    // NEW: QR Code Functions
    function saveQRCode(qrCodeData) {
        if(hasConsent) {
        let qrCodes = JSON.parse(localStorage.getItem('qrCodes')) || [];
        qrCodes.push(qrCodeData);
        if (qrCodes.length > 20) {
            qrCodes.shift();
        }
        localStorage.setItem('qrCodes', JSON.stringify(qrCodes));
        }
    }
    
    // NEW: Check if QR code access is valid (within 24 hours)
    function isQRCodeAccessValid() {
        const activationTime = hasConsent ? localStorage.getItem('qrCodeActivationTime') : null;
        if (!activationTime) return false;
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        return (now - parseInt(activationTime)) < oneDay;
    }
    
    // NEW: Show QR Code Screen with referral check
    function showQRCodeScreen() {
        synth.cancel();
        isSpeaking = false;
        
        // Check if access is valid
        if (!isQRCodeAccessValid()) {
            // Show referral program overlay
            showReferralScreen();
            return;
        }
        
        hideAllScreens();
        isQRCodeScreenVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        qrcodeContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        resetQRCodeForm();
    }
    
    function hideQRCodeScreen() {
        hideAllScreens();
        document.getElementById('chat-menu').classList.remove('active');
    }
    
    function resetQRCodeForm() {
        document.getElementById('qrcode-url-input').value = '';
        document.getElementById('qrcode-color-picker').value = '#000000';
        document.getElementById('qrcode-color-preview').style.background = '#000000';
        document.getElementById('qrcode-center-image-img').src = '';
        document.getElementById('qrcode-center-image-img').style.display = 'none';
        document.getElementById('qrcode-center-image-preview').querySelector('i').style.display = 'block';
        document.getElementById('qrcode-center-image-preview').classList.remove('has-image');
        document.getElementById('qrcode-result').classList.remove('active');
        qrcodeCenterImage = null;
    }
    
    // NEW: Generate QR Code with basic effects
    function generateQRCode() {
        const url = document.getElementById('qrcode-url-input').value.trim();
        if (!url) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –∏–ª–∏ —Ç–µ–∫—Å—Ç.');
            return;
        }
        
        const color = document.getElementById('qrcode-color-picker').value;
        const size = 300; // Fixed size for simplicity
        
        const options = {
            text: url,
            width: size,
            height: size,
            colorDark: color,
            colorLight: "#ffffff",
            correctLevel: QRErrorCorrectLevel.H
        };
        
        if (qrcodeCenterImage) {
            options.logo = qrcodeCenterImage;
            options.logoWidth = size / 4;
            options.logoHeight = size / 4;
            options.logoBackgroundTransparent = true;
        }
        
        const qrcodeDisplay = document.getElementById('qrcode-display');
        qrcodeDisplay.innerHTML = '';
        new QRCode(qrcodeDisplay, options);
        
        // Save QR code data
        const canvas = qrcodeDisplay.querySelector('canvas');
        const dataURL = canvas ? canvas.toDataURL('image/png') : '';
        const qrCodeData = {
            url: url,
            color: color,
            centerImage: qrcodeCenterImage,
            dataURL: dataURL,
            timestamp: Date.now()
        };
        saveQRCode(qrCodeData);
        document.getElementById('qrcode-result').classList.add('active');
    }
    
    function downloadQRCode() {
        const qrcodeDisplay = document.getElementById('qrcode-display');
        const canvas = qrcodeDisplay.querySelector('canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'qrcode.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } else {
            alert('QR-–∫–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.');
        }
    }
    
    function showImagePickerForQRCode() {
        const modal = document.getElementById('image-picker-modal-qrcode');
        const grid = document.getElementById('image-picker-grid-qrcode');
        grid.innerHTML = '';
        
        const recentImages = [...generatedImages].reverse().slice(0, 20);
        if (recentImages.length === 0) {
            grid.innerHTML = '<p style="text-align: center;">–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö –≤ —á–∞—Ç–µ.</p>';
        } else {
            recentImages.forEach(image => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('image-picker-item-qrcode');
                imgContainer.dataset.url = image.url;
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è QR-–∫–æ–¥–∞';
                imgContainer.appendChild(img);
                grid.appendChild(imgContainer);
                imgContainer.addEventListener('click', () => {
                    document.querySelectorAll('.image-picker-item-qrcode').forEach(item => item.classList.remove('selected'));
                    qrcodeCenterImage = imgContainer.dataset.url;
                    imgContainer.classList.add('selected');
                });
            });
        }
        modal.classList.add('active');
    }
    
    // NEW: Referral Program Functions
    function showReferralScreen() {
        document.getElementById('referral-overlay').classList.add('active');
    }
    
    function hideReferralScreen() {
        document.getElementById('referral-overlay').classList.remove('active');
    }
    
    // NEW: Activate referral access for QR code (valid for 24 hours)
    function activateQRCodeAccess() {
        if(hasConsent) {
        localStorage.setItem('qrCodeActivationTime', Date.now().toString());
        localStorage.setItem('isReferralActive', 'true');
        localStorage.setItem('referralActivationTime', Date.now().toString());
        }
        alert('–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 24 —á–∞—Å–∞!');
        hideReferralScreen();
        showQRCodeScreen(); // Now show the QR code screen
    }
    
    // NEW: Show QR Code Screen with referral check
    function showQRCodeScreen() {
        synth.cancel();
        isSpeaking = false;
        
        // Check if access is valid
        if (!isQRCodeAccessValid()) {
            // Show referral program overlay
            showReferralScreen();
            return;
        }
        
        hideAllScreens();
        isQRCodeScreenVisible = true;
        chatContainer.classList.add('hidden');
        topBar.classList.add('hidden');
        qrcodeContainer.classList.add('active');
        document.getElementById('chat-menu').classList.remove('active');
        resetQRCodeForm();
    }
    
    // NEW: Referral Event Listeners
    const referralLinkText = document.getElementById('referral-link-text');
    const copyLinkButton = document.getElementById('copy-link-button');
    const activateCodeButton = document.getElementById('activate-code-button');
    const closeReferralButton = document.getElementById('close-referral-button');
    const activationCodeInput = document.getElementById('activation-code-input');
    
    copyLinkButton.addEventListener('click', () => {
        navigator.clipboard.writeText(referralLinkText.innerText).then(() => {
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    });
    
    activateCodeButton.addEventListener('click', () => {
        const code = activationCodeInput.value.trim();
        // These codes are NOT visible to the user but work for activation
        if (['Techvision', '000025', 'zubr.by'].includes(code)) {
            activateQRCodeAccess();
        } else {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
    });
    
    closeReferralButton.addEventListener('click', hideReferralScreen);
    
    // Allow Enter key to activate code
    activationCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            activateCodeButton.click();
        }
    });
    
    // NEW: Universal Menu Button (replaced menu-button)
    const universalMenuButton = document.getElementById('universal-menu-button');
    universalMenuButton.addEventListener('click', () => {
        secondaryMenuScreen.classList.add('active');
    });
    
    // NEW: Secondary Menu Event Listeners
    const secondaryMenuScreen = document.getElementById('secondary-menu-screen');
    const closeSecondaryMenu = document.getElementById('close-secondary-menu');
    const secondaryLowVisionButton = document.getElementById('secondary-low-vision-button');
    const secondaryQRCodeButton = document.getElementById('secondary-qrcode-button');
    const secondaryProjectButton = document.getElementById('secondary-project-button');
    closeSecondaryMenu.addEventListener('click', () => {
        secondaryMenuScreen.classList.remove('active');
    });
    
    secondaryLowVisionButton.addEventListener('click', () => {
      isLowVisionMode = !isLowVisionMode;
      secondaryMenuScreen.classList.remove('active');
      document.body.classList.toggle('low-vision', isLowVisionMode);
      if (isLowVisionMode) {
        magnifier.style.display = 'block';
      } else {
        magnifier.style.display = 'none';
        removeAllZooms();
      }
    });
    
    secondaryQRCodeButton.addEventListener('click', () => {
        secondaryMenuScreen.classList.remove('active');
        showQRCodeScreen();
    });
    
    secondaryProjectButton.addEventListener('click', () => {
        secondaryMenuScreen.classList.remove('active');
        showProjectScreen();
    });
    
    // NEW: Add event listener for notes button in secondary menu
    const secondaryNotesButton = document.getElementById('secondary-notes-button');
    secondaryNotesButton.addEventListener('click', () => {
        secondaryMenuScreen.classList.remove('active');
        showNotesScreen();
    });
    
    // NEW: Music button in secondary menu
    const secondaryMusicButton = document.getElementById('secondary-music-button');
    secondaryMusicButton.addEventListener('click', showMusicComposer);
    
    // NEW: Close music composer
    const closeMusicButton = document.getElementById('close-music-button');
    closeMusicButton.addEventListener('click', () => {
        musicComposerContainer.classList.remove('active');
        hideAllScreens();
    });
    
    // NEW: Low Vision Mode Logic
    let isLowVisionMode = false;
    const magnifier = document.getElementById('magnifier');
    let isDraggingMag = false;
    let magStartX = 0;
    let magStartY = 0;

    function removeAllZooms() {
      document.querySelectorAll('.magnifier-hover').forEach(el => el.classList.remove('magnifier-hover'));
    }

    // Draggable magnifier
    magnifier.addEventListener('mousedown', (e) => {
      isDraggingMag = true;
      magStartX = e.clientX - magnifier.offsetLeft;
      magStartY = e.clientY - magnifier.offsetTop;
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (isDraggingMag) {
        magnifier.style.left = (e.clientX - magStartX) + 'px';
        magnifier.style.top = (e.clientY - magStartY) + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      isDraggingMag = false;
    });

    // Zoom logic: check intersection every 100ms
    setInterval(() => {
      if (!isLowVisionMode) return;
      const magRect = magnifier.getBoundingClientRect();
      // Select text-containing elements
      const textElements = document.querySelectorAll('.chat-message, input[type="text"], button, span, p, h2, h3, li, .note-content, .post-text, .album-content, .toolbar-section h4, .project-header h2');
      textElements.forEach(el => {
        const elRect = el.getBoundingClientRect();
        if (intersects(magRect, elRect)) {
          el.classList.add('magnifier-hover');
        } else {
          el.classList.remove('magnifier-hover');
        }
      });
    }, 100);

    function intersects(rect1, rect2) {
      return !(rect1.right < rect2.left || 
               rect1.left > rect2.right || 
               rect1.bottom < rect2.top || 
               rect1.top > rect2.bottom);
    }

    // Existing Event Listeners and Initial Setup
    document.addEventListener('DOMContentLoaded', () => {
      const speakToggleButton = document.getElementById('speak-toggle-button');
      if (isSpeechEnabled) {
          speakToggleButton.classList.add('active');
      }
      speakToggleButton.addEventListener('click', () => {
          isSpeechEnabled = !isSpeechEnabled;
          if(hasConsent) localStorage.setItem('isSpeechEnabled', isSpeechEnabled);
          speakToggleButton.classList.toggle('active');
          if (!isSpeechEnabled) {
              synth.cancel(); 
              isSpeaking = false;
              addChatMessage('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤—ã–∫–ª—é—á–µ–Ω–æ. üîá', 'assistant');
              subtitleBox.classList.remove('active');
              subtitleBox.innerText = '';
          } else {
              addChatMessage('–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ. üòä', 'assistant');
          }
      });
      document.getElementById('menu-toggle-button').addEventListener('click', () => {
        document.getElementById('chat-menu').classList.toggle('active');
      });
      document.getElementById('new-chat-button').addEventListener('click', createNewChat);
      document.getElementById('albums-menu-button').addEventListener('click', showAlbumsScreen);
      document.getElementById('back-to-chat-button').addEventListener('click', hideAllScreens);
      document.getElementById('back-to-chat-from-albums-button').addEventListener('click', hideAllScreens);
      document.getElementById('add-note-button').addEventListener('click', () => showNoteEditor());
      document.getElementById('save-note-button').addEventListener('click', saveNote);
      document.getElementById('delete-note-button').addEventListener('click', () => deleteNote(editingNoteId));
      document.getElementById('cancel-note-button').addEventListener('click', showNotesList);
      document.getElementById('add-album-button').addEventListener('click', showAlbumCreator);
      document.getElementById('save-album-button').addEventListener('click', createNewAlbum);
      document.getElementById('cancel-album-button').addEventListener('click', showAlbumsList);
      document.getElementById('delete-album-button').addEventListener('click', (e) => deleteAlbum(e.target.dataset.id));
      document.getElementById('back-to-albums-list-button').addEventListener('click', showAlbumsList);
      document.getElementById('chat-form').addEventListener('submit', handleAssistantSubmit);
      document.getElementById('go-to-creator-button').addEventListener('click', showPostCreatorScreen);
      document.getElementById('back-to-feed-button').addEventListener('click', showStoryFeedScreen);
      document.getElementById('back-to-chat-from-feed-button').addEventListener('click', hideAllScreens);
      document.getElementById('select-avatar-button').addEventListener('click', () => document.getElementById('avatar-file-input').click());
      document.getElementById('avatar-file-input').addEventListener('change', handleAvatarSelection);
      document.getElementById('publish-post-button').addEventListener('click', handlePostPublish);
      document.getElementById('qrcode-menu-button').addEventListener('click', showQRCodeScreen);
      document.getElementById('back-to-chat-from-qrcode-button').addEventListener('click', hideAllScreens);
      document.getElementById('qrcode-color-picker').addEventListener('input', (e) => {
          document.getElementById('qrcode-color-preview').style.background = e.target.value;
      });
      document.getElementById('qrcode-center-image-preview').addEventListener('click', showImagePickerForQRCode);
      document.getElementById('qrcode-generate-button').addEventListener('click', generateQRCode);
      document.getElementById('qrcode-download-button').addEventListener('click', downloadQRCode);
      document.getElementById('confirm-image-selection-qrcode').addEventListener('click', () => {
          if (qrcodeCenterImage) {
              document.getElementById('qrcode-center-image-img').src = qrcodeCenterImage;
              document.getElementById('qrcode-center-image-img').style.display = 'block';
              document.getElementById('qrcode-center-image-preview').querySelector('i').style.display = 'none';
              document.getElementById('qrcode-center-image-preview').classList.add('has-image');
          }
          document.getElementById('image-picker-modal-qrcode').classList.remove('active');
      });
      document.getElementById('cancel-image-selection-qrcode').addEventListener('click', () => {
          document.getElementById('image-picker-modal-qrcode').classList.remove('active');
          qrcodeCenterImage = null;
      });
      if (!currentChatId || !chats.find(c => c.id === currentChatId) || chats.length === 0) {
        createNewChat();
      } else {
        loadChat(currentChatId);
      }
      updateWeatherWidget();
      setInterval(updateWeatherWidget, 600000);
      applySavedBackground();
      applySavedWallpaper();
      setCurrentMode(currentMode);
      document.querySelector('.font-option').classList.add('selected');
      document.querySelector('.color-option').classList.add('selected');
    });








// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
document.getElementById('secondary-story-button')?.addEventListener('click', () => {
  document.getElementById('story-creator-overlay').classList.add('active');
  document.getElementById('secondary-menu-screen').classList.remove('active');
});

document.querySelector('.close-story-modal')?.addEventListener('click', () =>
  document.getElementById('story-creator-overlay').classList.remove('active')
);

['.close-story-viewer', '#close-story-viewer-btn'].forEach(sel => {
  document.querySelector(sel)?.addEventListener('click', () =>
    document.getElementById('story-viewer-overlay').classList.remove('active')
  );
});

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—Å–∫–∞–∑–∞
document.getElementById('generate-story-button')?.addEventListener('click', async () => {
  const prompt = document.getElementById('story-prompt-input').value.trim();
  if (!prompt) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ —Ç–µ–º—É —Ä–∞—Å—Å–∫–∞–∑–∞.');

  const font = document.getElementById('story-font-select').value;
  const color = document.getElementById('story-color-picker').value;

  // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
  document.getElementById('story-loading-overlay').classList.add('active');
  document.getElementById('story-creator-overlay').classList.remove('active');

  try {
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
    const storyPrompt = `–ù–∞–ø–∏—à–∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑ –Ω–∞ —Ç–µ–º—É: "${prompt}". –†–∞—Å—Å–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—å–Ω—ã–º, –æ–±—ä—ë–º–Ω—ã–º, —Å –∑–∞–≤—è–∑–∫–æ–π, –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–µ–π –∏ —Ä–∞–∑–≤—è–∑–∫–æ–π. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å–∫–∞–∑–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;
    const storyText = await getAIResponse(storyPrompt);
    if (!storyText) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Å–∫–∞–∑.');

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const midPrompt = `–°–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–µ—Ä–µ–¥–∏–Ω—ã —Ä–∞—Å—Å–∫–∞–∑–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç–µ: "${storyText.substring(0, 500)}..."`;
    const endPrompt = `–°–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ü–∞ —Ä–∞—Å—Å–∫–∞–∑–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç–µ: "...${storyText.slice(-500)}"`;
    
    const enMid = await translateText(midPrompt, 'en');
    const enEnd = await translateText(endPrompt, 'en');
    
    const midImgUrl = `${IMAGE_API_URL}${encodeURIComponent(enMid)}`;
    const endImgUrl = `${IMAGE_API_URL}${encodeURIComponent(enEnd)}`;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º
    currentStory = { prompt, text: storyText, font, color, midImgUrl, endImgUrl, timestamp: Date.now() };

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
    renderStoryInViewer(storyText, font, color, midImgUrl, endImgUrl);

  } catch (err) {
    console.error(err);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Å–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } finally {
    document.getElementById('story-loading-overlay').classList.remove('active');
  }
});

function renderStoryInViewer(text, font, color, midImg, endImg) {
  const half = Math.floor(text.length / 2);
  const before = text.substring(0, half);
  const after = text.substring(half);

  document.getElementById('story-content').innerHTML = `
    <div style="font-family: ${font}; color: ${color};">
      ${before}
      <br><br>
      <img src="${midImg}" style="max-width:100%; border-radius:12px; margin:20px 0;">
      <br><br>
      ${after}
      <br><br>
      <img src="${endImg}" style="max-width:100%; border-radius:12px; margin:20px 0;">
    </div>
  `;
  document.getElementById('story-viewer-overlay').classList.add('active');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
document.getElementById('save-story-button')?.addEventListener('click', () => {
  if (!currentStory) return;
  let saved = hasConsent ? JSON.parse(localStorage.getItem('savedStories') || '[]') : [];
  saved.push(currentStory);
  if (hasConsent) localStorage.setItem('savedStories', JSON.stringify(saved));
  alert('‚úÖ –†–∞—Å—Å–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
});
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ—Å–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –ò–ò
async function generateRetell(text) {
  const prompt = `–ö—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏. –¢–µ–∫—Å—Ç: "${text}"`;
  const response = await getAIResponse(prompt);
  return response;
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø–µ—Ä–µ—Å–∫–∞–∑–æ–º
async function openRetellModal(noteText) {
  const overlay = document.getElementById('retell-modal-overlay');
  const content = document.getElementById('retell-content');
  
  content.innerHTML = '<p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ—Å–∫–∞–∑–∞...</p>';
  overlay.classList.add('active');

  try {
    const retell = await generateRetell(noteText);
    content.innerHTML = retell
      .replace(/\n/g, '<br>')
      .replace(/<PM>(.*?)<\/PM>/g, '<div class="pm-header">$1</div>');
  } catch (err) {
    content.innerHTML = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    console.error(err);
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeRetellModal() {
  document.getElementById('retell-modal-overlay').classList.remove('active');
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ—Å–∫–∞–∑–∞—Ç—å" –≤ –∫–∞–∂–¥—É—é –∑–∞–º–µ—Ç–∫—É
function addRetellButtonToNote(li, noteText) {
  const actionsDiv = li.querySelector('.note-actions');
  if (!actionsDiv) return;

  // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
  if (actionsDiv.querySelector('.retell-note-button')) return;

  const retellButton = document.createElement('button');
  retellButton.classList.add('retell-note-button');
  retellButton.innerHTML = '<i class="fas fa-comment-dots"></i>';
  retellButton.title = '–ü–µ—Ä–µ—Å–∫–∞–∑–∞—Ç—å –∑–∞–º–µ—Ç–∫—É';
  retellButton.style.marginLeft = '10px';
  retellButton.style.fontSize = '1.2em';
  retellButton.style.color = '#1E90FF';
  retellButton.addEventListener('click', (e) => {
    e.stopPropagation();
    openRetellModal(noteText);
  });
  actionsDiv.appendChild(retellButton);
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º renderNotes(), —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ—Å–∫–∞–∑–∞
const originalRenderNotes = renderNotes;
renderNotes = function() {
  originalRenderNotes();
  // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
  document.querySelectorAll('.note-item').forEach(li => {
    const noteId = li.dataset.noteId;
    const note = notes.find(n => n.id === noteId);
    if (note) {
      addRetellButtonToNote(li, note.text);
    }
  });
};
document.getElementById('close-retell-btn').addEventListener('click', closeRetellModal);
document.querySelector('.close-retell-modal').addEventListener('click', closeRetellModal);
document.getElementById('retell-modal-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('retell-modal-overlay')) {
    closeRetellModal();
  }
});

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç" ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
document.getElementById('project-menu-button').addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  window.location.href = 'https://zubrmax-ai.neocities.org/text';
});

// –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç" –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –º–µ–Ω—é
document.getElementById('secondary-project-button').addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  window.location.href = 'https://zubrmax-ai.neocities.org/text';
});
    // –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —ç–º–æ–¥–∑–∏
let savedEmojis = hasConsent ? JSON.parse(localStorage.getItem('savedEmojis')) || [] : [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
function isReferralProgramActive() {
    if (!hasConsent) return false;
    const isActive = localStorage.getItem('isReferralActive') === 'true';
    const activationTime = parseInt(localStorage.getItem('referralActivationTime') || '0');
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000;
    
    return isActive && (now - activationTime < oneDay);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–º–æ–¥–∑–∏
function saveEmoji(emojiData) {
    savedEmojis.push(emojiData);
    if(hasConsent) localStorage.setItem('savedEmojis', JSON.stringify(savedEmojis));
    renderSavedEmojis();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —ç–º–æ–¥–∑–∏
function renderSavedEmojis() {
    const grid = document.getElementById('saved-emojis-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (savedEmojis.length === 0) {
        grid.innerHTML = '<p style="text-align: center; opacity: 0.7;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —ç–º–æ–¥–∑–∏</p>';
        return;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 —ç–º–æ–¥–∑–∏
    const recentEmojis = [...savedEmojis].reverse().slice(0, 12);
    
    recentEmojis.forEach(emoji => {
        const item = document.createElement('div');
        item.classList.add('saved-emoji-item');
        
        const img = document.createElement('img');
        img.src = emoji.imageUrl;
        img.alt = emoji.description;
        img.title = `${emoji.description} (${emoji.style})`;
        
        item.appendChild(img);
        grid.appendChild(item);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ API
async function generateEmoji(description, style) {
    try {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingText = `–ü—Ä–∏–≤–µ—Ç! üòä –°–æ–∑–¥–∞–µ–º —ç–º–æ–¥–∑–∏ "${description}" –≤ —Å—Ç–∏–ª–µ ${style}...`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingSubtext = document.querySelector('.loading-subtext');
        if (loadingSubtext) {
            loadingSubtext.textContent = loadingText;
        }
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è API
        const translatedPrompt = await translateText(`${description} –≤ —Å—Ç–∏–ª–µ ${style}`, 'en');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è API —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–¥ —ç–º–æ–¥–∑–∏
        const emojiPrompt = `${translatedPrompt}, emoji style, simple, clean, expressive, colorful, vector, transparent background`;
        const imageUrl = `${IMAGE_API_URL}${encodeURIComponent(emojiPrompt)}?width=512&height=512`;
        
        // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return imageUrl;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–æ–¥–∑–∏:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingAnimation() {
    const loadingElement = document.getElementById('emoji-loading');
    const generatedImage = document.getElementById('emoji-generated-image');
    const saveButton = document.getElementById('save-emoji-button');
    
    if (loadingElement) {
        loadingElement.classList.add('active');
    }
    
    if (generatedImage) {
        generatedImage.classList.remove('active');
        generatedImage.innerHTML = '';
    }
    
    if (saveButton) {
        saveButton.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function hideLoadingAnimation() {
    const loadingElement = document.getElementById('emoji-loading');
    if (loadingElement) {
        loadingElement.classList.remove('active');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã —ç–º–æ–¥–∑–∏
function resetEmojiForm() {
    document.getElementById('emoji-description').value = '';
    document.getElementById('emoji-style-select').value = '—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π';
    
    const resultArea = document.getElementById('emoji-generated-image');
    if (resultArea) {
        resultArea.classList.remove('active');
        resultArea.innerHTML = '';
        resultArea.dataset.currentEmojiUrl = '';
        resultArea.dataset.currentDescription = '';
        resultArea.dataset.currentStyle = '';
    }
    
    document.getElementById('save-emoji-button').style.display = 'none';
    hideLoadingAnimation();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å —ç–º–æ–¥–∑–∏"
document.getElementById('create-emoji-button')?.addEventListener('click', () => {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
    inputDropdownMenu.classList.remove('active');
    inputMenuButton.classList.remove('active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    resetEmojiForm();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
    if (isReferralProgramActive()) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏
        document.getElementById('emoji-creator-interface').style.display = 'block';
        document.getElementById('emoji-referral-prompt').style.display = 'none';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏
        renderSavedEmojis();
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
        document.getElementById('emoji-creator-interface').style.display = 'none';
        document.getElementById('emoji-referral-prompt').style.display = 'block';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('emoji-modal-overlay').classList.add('active');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —ç–º–æ–¥–∑–∏
document.querySelector('.close-emoji-modal')?.addEventListener('click', () => {
    document.getElementById('emoji-modal-overlay').classList.remove('active');
    resetEmojiForm();
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('emoji-modal-overlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'emoji-modal-overlay') {
        document.getElementById('emoji-modal-overlay').classList.remove('active');
        resetEmojiForm();
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–æ–¥–∑–∏
document.getElementById('generate-emoji-button')?.addEventListener('click', async () => {
    const description = document.getElementById('emoji-description').value.trim();
    const style = document.getElementById('emoji-style-select').value;
    
    if (!description) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ —ç–º–æ–¥–∑–∏');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
    showLoadingAnimation();
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const generateButton = document.getElementById('generate-emoji-button');
    const originalText = generateButton.innerHTML;
    generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ–∑–¥–∞–Ω–∏–µ...';
    generateButton.disabled = true;
    
    try {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–æ–¥–∑–∏
        const emojiUrl = await generateEmoji(description, style);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        hideLoadingAnimation();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const resultArea = document.getElementById('emoji-generated-image');
        const img = document.createElement('img');
        img.src = emojiUrl;
        img.alt = `–≠–º–æ–¥–∑–∏: ${description}`;
        img.onload = () => {
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            resultArea.innerHTML = '';
            resultArea.appendChild(img);
            resultArea.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            document.getElementById('save-emoji-button').style.display = 'flex';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            resultArea.dataset.currentEmojiUrl = emojiUrl;
            resultArea.dataset.currentDescription = description;
            resultArea.dataset.currentStyle = style;
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        img.onerror = () => {
            hideLoadingAnimation();
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        };
        
    } catch (error) {
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        hideLoadingAnimation();
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–º–æ–¥–∑–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        console.error(error);
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        generateButton.innerHTML = originalText;
        generateButton.disabled = false;
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–º–æ–¥–∑–∏
document.getElementById('save-emoji-button')?.addEventListener('click', () => {
    const resultArea = document.getElementById('emoji-generated-image');
    const imageUrl = resultArea.dataset.currentEmojiUrl;
    const description = resultArea.dataset.currentDescription;
    const style = resultArea.dataset.currentStyle;
    
    if (!imageUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —ç–º–æ–¥–∑–∏');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —ç–º–æ–¥–∑–∏
    const emojiData = {
        id: Date.now().toString(),
        imageUrl: imageUrl,
        description: description,
        style: style,
        timestamp: Date.now()
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º
    saveEmoji(emojiData);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    document.getElementById('save-emoji-button').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    const successMessage = document.createElement('div');
    successMessage.className = 'success-message';
    successMessage.innerHTML = '<i class="fas fa-check-circle"></i> –≠–º–æ–¥–∑–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!';
    successMessage.style.cssText = `
        background: linear-gradient(135deg, #28a745, #218838);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        margin-top: 10px;
        font-weight: bold;
        animation: fadeIn 0.3s ease;
    `;
    
    const resultAreaContainer = document.getElementById('emoji-result-area');
    resultAreaContainer.appendChild(successMessage);
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (successMessage.parentNode) {
            successMessage.remove();
        }
    }, 3000);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('open-referral-from-emoji')?.addEventListener('click', () => {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–º–æ–¥–∑–∏
    document.getElementById('emoji-modal-overlay').classList.remove('active');
    resetEmojiForm();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
    document.getElementById('referral-overlay').classList.add('active');
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function initEmojiModule() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    renderSavedEmojis();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å —ç–º–æ–¥–∑–∏" –≤ –º–µ–Ω—é, –µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç
    if (!document.getElementById('create-emoji-button')) {
        const createEmojiButton = document.createElement('button');
        createEmojiButton.type = 'button';
        createEmojiButton.className = 'menu-item';
        createEmojiButton.id = 'create-emoji-button';
        createEmojiButton.innerHTML = `
            <span>–°–æ–∑–¥–∞—Ç—å —ç–º–æ–¥–∑–∏</span>
            <i class="fas fa-smile"></i>
        `;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const generateImageButton = document.getElementById('generate-image-button');
        if (generateImageButton && generateImageButton.parentNode) {
            generateImageButton.parentNode.insertBefore(createEmojiButton, generateImageButton.nextSibling);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
        createEmojiButton.addEventListener('click', () => {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
            inputDropdownMenu.classList.remove('active');
            inputMenuButton.classList.remove('active');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            resetEmojiForm();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
            if (isReferralProgramActive()) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–∑–¥–∞–Ω–∏—è —ç–º–æ–¥–∑–∏
                document.getElementById('emoji-creator-interface').style.display = 'block';
                document.getElementById('emoji-referral-prompt').style.display = 'none';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏
                renderSavedEmojis();
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
                document.getElementById('emoji-creator-interface').style.display = 'none';
                document.getElementById('emoji-referral-prompt').style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('emoji-modal-overlay').classList.add('active');
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è —ç–º–æ–¥–∑–∏
    initEmojiModule();
  // Welcome modal logic ‚Äî show once per 24 hours
const lastSeenDate = localStorage.getItem('welcomeLastSeenDate');
const today = new Date().toLocaleDateString('ru-RU');
const welcomeModal = document.getElementById('welcome-modal');
const welcomeDateText = document.getElementById('welcome-date-text');

if (lastSeenDate !== today) {
  welcomeDateText.innerText = `–°–µ–≥–æ–¥–Ω—è: ${today}`;
  welcomeModal.classList.add('active');
  localStorage.setItem('welcomeLastSeenDate', today);
  setTimeout(() => {
    welcomeModal.classList.remove('active');
  }, 3000); // 3 seconds
}
});
  </script>
<script>
// –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
const loadingContainer = document.createElement('div');
loadingContainer.id = 'response-loading-animation';
loadingContainer.style.cssText = `
  position: absolute;
  bottom: -65px; /* 1.5 —Å–º = ~57px + –æ—Ç—Å—Ç—É–ø */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  height: 20px;
  display: none;
  z-index: 10;
`;

// –°–æ–∑–¥–∞–µ–º 4 –ø–∞–ª–∫–∏
for (let i = 1; i <= 4; i++) {
  const bar = document.createElement('div');
  bar.className = 'loading-bar';
  bar.style.cssText = `
    width: 14px; /* –®–∏—Ä–æ–∫–∏–µ –ø–∞–ª–∫–∏ */
    height: 6px; /* –ù–∏–∑–∫–∏–µ –≤ –±–∞–∑–æ–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
    background-color: #4682B4; /* –¶–≤–µ—Ç steel blue –∫–∞–∫ –ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å */
    border-radius: 3px;
    transition: height 0.3s ease;
  `;
  loadingContainer.appendChild(bar);
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ DOM
document.querySelector('.input-container').appendChild(loadingContainer);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
function startResponseAnimation() {
  loadingContainer.style.display = 'flex';
  
  let currentBar = 0;
  const bars = document.querySelectorAll('.loading-bar');
  
  // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
  function animateBars() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–ª–∫–∏ –≤ –±–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    bars.forEach(bar => {
      bar.style.height = '6px'; // –ë–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞
    });
    
    // –ê–Ω–∏–º–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –ø–∞–ª–∫—É - –ø–æ–¥–Ω–∏–º–∞–µ–º –µ–µ, –∑–∞—Ç–µ–º –æ–ø—É—Å–∫–∞–µ–º
    if (bars[currentBar]) {
      // –ü–æ–¥–Ω–∏–º–∞–µ–º –ø–∞–ª–∫—É
      bars[currentBar].style.height = '20px'; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
      
      // –ß–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–¥–µ—Ä–∂–∫—É –æ–ø—É—Å–∫–∞–µ–º –ø–∞–ª–∫—É –æ–±—Ä–∞—Ç–Ω–æ
      setTimeout(() => {
        if (bars[currentBar]) {
          bars[currentBar].style.height = '6px'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –±–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }
      }, 200);
    }
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞–ª–∫–µ
    currentBar = (currentBar + 1) % bars.length;
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
  const animationInterval = setInterval(animateBars, 400);
  
  return animationInterval;
}

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
function stopResponseAnimation(animationInterval) {
  clearInterval(animationInterval);
  loadingContainer.style.display = 'none';
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö –ø–∞–ª–æ–∫
  const bars = document.querySelectorAll('.loading-bar');
  bars.forEach(bar => {
    bar.style.height = '6px'; // –ë–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞
  });
}

// –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
const originalHandleAssistantSubmit = window.handleAssistantSubmit;
window.handleAssistantSubmit = async function(event) {
  event.preventDefault();
  const inputField = document.getElementById('prompt-input');
  let prompt = inputField.value.trim();
  
  if (prompt === '') return;
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  const animationInterval = startResponseAnimation();
  
  try {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    await originalHandleAssistantSubmit(event);
  } finally {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    stopResponseAnimation(animationInterval);
  }
};

// –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const originalAddChatMessage = window.addChatMessage;
window.addChatMessage = function(message, sender, isImage = false, prompt = '') {
  // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –ò–ò –∏ —ç—Ç–æ –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  if (sender === 'assistant' && !isImage && !message.startsWith('–í–æ—Ç —á—Ç–æ —è –Ω–∞—à–µ–ª –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ')) {
    const animationInterval = startResponseAnimation();
    setTimeout(() => {
      stopResponseAnimation(animationInterval);
      originalAddChatMessage(message, sender, isImage, prompt);
    }, 1000);
  } else {
    originalAddChatMessage(message, sender, isImage, prompt);
  }
};
</script>
</body>
</html>
